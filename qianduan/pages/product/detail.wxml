<!--pages/product/detail.wxml - å•†å“è¯¦æƒ…-->
<view class="container">
  <!-- å•†å“å›¾ç‰‡ -->
  <view class="gallery">
    <swiper class="gallery-swiper" 
            autoplay circular 
            current="{{currentImage}}"
            bindchange="onImageChange">
      <swiper-item wx:for="{{product.images || []}}" wx:key="index">
        <image class="gallery-image" src="{{item}}" mode="aspectFill" bindtap="onPreviewImage" data-index="{{index}}"></image>
      </swiper-item>
    </swiper>
    <view class="gallery-counter">
      <text>{{currentImage + 1}}/{{imageCount}}</text>
    </view>
    <view class="back-btn" bindtap="onBack">â€¹</view>
  </view>

  <!-- å•†å“ä¿¡æ¯ -->
  <view class="product-section">
    <view class="price-row">
      <text class="current-price">{{product.displayPrice || product.retail_price || '0.00'}}</text>
      <text class="original-price" wx:if="{{product.original_price}}">Â¥{{product.original_price}}</text>
      <view class="price-tag" wx:if="{{roleLevel > 0}}">{{roleLevel === 1 ? 'ä¼šå‘˜ä»·' : (roleLevel === 2 ? 'å›¢é•¿ä»·' : 'ä»£ç†ä»·')}}</view>
    </view>
    <text class="product-name">{{product.name}}</text>
    <text class="product-desc" wx:if="{{product.subtitle}}">{{product.subtitle}}</text>
  </view>

  <!-- æœåŠ¡ -->
  <view class="service-row">
    <view class="service-item">
      <text>âœ“ æ­£å“ä¿è¯</text>
    </view>
    <view class="service-item">
      <text>âœ“ å“è´¨ç›´å‘</text>
    </view>
    <view class="service-item">
      <text>âœ“ å”®åæ— å¿§</text>
    </view>
  </view>

  <!-- è§„æ ¼é€‰æ‹© -->
  <view class="spec-entry" bindtap="onShowSku" wx:if="{{skus.length > 0}}">
    <text class="spec-label">è§„æ ¼</text>
    <view class="spec-value">
      <text wx:if="{{selectedSku}}">{{selectedSku.spec_value}}</text>
      <text wx:else>è¯·é€‰æ‹©</text>
    </view>
    <text class="spec-arrow">â€º</text>
  </view>

  <!-- å•†å“è¯¦æƒ… -->
  <view class="detail-section">
    <view class="detail-title">
      <text class="line"></text>
      <text>å•†å“è¯¦æƒ…</text>
      <text class="line"></text>
    </view>
    <view class="detail-content">
      <rich-text nodes="{{product.description || ''}}"></rich-text>
      <block wx:for="{{product.detail_images || []}}" wx:key="index">
        <image class="detail-image" src="{{item}}" mode="widthFix"></image>
      </block>
      <view class="empty" wx:if="{{!product.description && (!product.detail_images || product.detail_images.length === 0)}}">
        <text class="empty-text">æš‚æ— è¯¦æƒ…</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ  -->
  <view class="action-bar safe-bottom">
    <view class="action-icons">
      <navigator url="/pages/cart/cart" open-type="switchTab" class="action-icon">
        <text>ğŸ›’</text>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </navigator>
    </view>
    <view class="action-btns">
      <view class="btn btn-secondary" bindtap="onAddToCart">åŠ å…¥è´­ç‰©è½¦</view>
      <view class="btn btn-primary" bindtap="onBuyNow">ç«‹å³è´­ä¹°</view>
    </view>
  </view>

  <!-- SKUå¼¹çª— -->
  <view class="sku-popup {{showSku ? 'show' : ''}}">
    <view class="sku-mask" bindtap="onHideSku"></view>
    <view class="sku-content">
      <view class="sku-header">
        <image class="sku-image" src="{{(selectedSku && selectedSku.image) || (product.images && product.images[0]) || ''}}" mode="aspectFill"></image>
        <view class="sku-info">
          <text class="sku-price">{{(selectedSku && selectedSku.retail_price) || product.retail_price}}</text>
          <text class="sku-stock">åº“å­˜: {{(selectedSku && selectedSku.stock) || product.stock || 0}}</text>
        </view>
        <view class="sku-close" bindtap="onHideSku">âœ•</view>
      </view>
      
      <view class="sku-specs">
        <view class="spec-group">
          <text class="spec-name">è§„æ ¼</text>
          <view class="spec-list">
            <view class="spec-item {{selectedSku && selectedSku.id === item.id ? 'active' : ''}} {{item.stock <= 0 ? 'disabled' : ''}}"
                  wx:for="{{skus}}" wx:key="id"
                  bindtap="onSelectSku" data-sku="{{item}}">
              {{item.spec_value}}
            </view>
          </view>
        </view>
      </view>

      <view class="sku-quantity">
        <text>æ•°é‡</text>
        <view class="quantity-ctrl">
          <view class="qty-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="onQuantityMinus">âˆ’</view>
          <text class="qty-num">{{quantity}}</text>
          <view class="qty-btn" bindtap="onQuantityPlus">+</view>
        </view>
      </view>

      <view class="sku-btns">
        <view class="btn btn-secondary btn-block" bindtap="onConfirmAddCart">åŠ å…¥è´­ç‰©è½¦</view>
        <view class="btn btn-primary btn-block" bindtap="onConfirmBuy">ç«‹å³è´­ä¹°</view>
      </view>
    </view>
  </view>
</view>
