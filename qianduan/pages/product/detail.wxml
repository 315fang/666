<!--pages/product/detail.wxml-->
<view class="container">
  <!-- 1. Floating Nav Bar (Transparent) -->
  <view class="nav-float-bar safe-top" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-actions">
      <view class="nav-btn-circle" bindtap="onBackTap">
        <text class="nav-icon">←</text>
      </view>
      <view class="nav-right-actions">
        <button class="nav-btn-circle" bindtap="onToggleFavorite">
          <text class="nav-icon {{isFavorite ? 'filled' : ''}}">♥</text>
        </button>
        <button class="nav-btn-circle" open-type="share">
          <text class="nav-icon">↗</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 2. Fullscreen Carousel -->
  <view class="hero-carousel">
    <swiper class="swiper-full" indicator-dots="{{true}}" autoplay="{{true}}" circular="{{true}}" indicator-color="rgba(255,255,255,0.4)" indicator-active-color="#ffffff">
      <swiper-item wx:for="{{product.images}}" wx:key="*this">
        <image src="{{item}}" mode="aspectFill" class="slide-image" bindtap="onPreviewImage" data-src="{{item}}"></image>
      </swiper-item>
    </swiper>
  </view>

  <!-- 3. Main Content Card (Overlapping) -->
  <view class="content-card">
    <!-- Price & Title -->
    <view class="header-section">
      <view class="price-row">
        <view class="price-main">
          <text class="currency">¥</text>
          <text class="amount">{{currentPrice || product.price}}</text>
        </view>
        <view class="price-sub" wx:if="{{product.market_price}}">
          ¥{{product.market_price}}
        </view>
      </view>
      
      <view class="agent-box" wx:if="{{isAgent && commission > 0}}">
         <view class="agent-tag">
            <text class="agent-icon">📈</text>
            <text class="agent-text">代理商特权：分享赚 ¥{{commission}}</text>
         </view>
         <text class="agent-arrow">›</text>
      </view>

      <view class="product-title">{{product.name}}</view>
      
      <view class="tags-row">
         <view class="tag-item">官方正品</view>
         <view class="tag-item">顺丰包邮</view>
         <view class="tag-item">七天无理由</view>
      </view>
    </view>

    <!-- Agent Incentive -->
    <view class="agent-incentive-card" wx:if="{{isAgent && commission > 0}}">
      <view class="incentive-left">
        <view class="icon-box">💰</view>
        <view class="incentive-info">
          <text class="incentive-title">推广赚 ¥{{commission}}</text>
          <text class="incentive-sub">分享给好友下单即可获得</text>
        </view>
      </view>
      <view class="incentive-arrow">→</view>
    </view>

    <!-- Service Guarantee -->
    <view class="service-row">
      <view class="service-item">
        <text class="check-icon">✓</text>
        <text>官方正品</text>
      </view>
      <view class="service-item">
        <text class="check-icon">✓</text>
        <text>极速发货</text>
      </view>
      <view class="service-item">
        <text class="check-icon">✓</text>
        <text>售后无忧</text>
      </view>
    </view>

    <!-- Spec Selector -->
    <view class="selector-card" bindtap="showSkuModal">
      <view class="selector-left">
        <text class="selector-label">已选</text>
        <text class="selector-value">{{selectedSkuText || '请选择规格'}}</text>
      </view>
      <text class="selector-arrow">›</text>
    </view>

    <!-- Product Details (Rich Text) -->
    <view class="detail-block">
      <view class="block-title">商品详情</view>
      <view class="rich-content">
        <rich-text nodes="{{product.detail_html || '暂无详情'}}"></rich-text>
      </view>
    </view>
  </view>

  <!-- Spec Modal -->
  <view class="sku-modal {{showSku ? 'show' : ''}}" bindtap="hideSkuModal">
    <view class="sku-content" catchtap="stopP">
      <view class="sku-header">
        <image src="{{selectedSkuImg || product.images[0]}}" mode="aspectFill" class="sku-thumb"></image>
        <view class="sku-info">
          <view class="sku-price">¥{{currentPrice}}</view>
          <view class="sku-stock">库存: {{currentStock}}件</view>
          <view class="sku-selected">已选: {{selectedSkuText}}</view>
        </view>
        <view class="close-btn" bindtap="hideSkuModal">✕</view>
      </view>
      
      <scroll-view scroll-y class="sku-scroll">
        <!-- Specs Loop -->
        <view class="spec-group" wx:for="{{product.specs}}" wx:key="name">
          <view class="spec-title">{{item.name}}</view>
          <view class="spec-values">
            <view class="spec-chip {{selectedSpecs[item.name] === val ? 'active' : ''}}" 
                  wx:for="{{item.values}}" wx:for-item="val" wx:key="*this"
                  bindtap="onSpecSelect" data-key="{{item.name}}" data-val="{{val}}">
              {{val}}
            </view>
          </view>
        </view>

        <!-- Quantity -->
        <view class="quantity-row">
          <text class="qty-label">购买数量</text>
          <view class="stepper">
            <view class="step-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="onMinus">-</view>
            <input class="step-input" type="number" value="{{quantity}}" bindinput="onQtyInput" />
            <view class="step-btn" bindtap="onPlus">+</view>
          </view>
        </view>
      </scroll-view>

      <view class="sku-footer safe-bottom">
        <view class="btn-group">
          <view class="btn-cart" bindtap="onAddToCart">加入购物车</view>
          <view class="btn-buy" bindtap="onBuyNow">立即购买</view>
        </view>
      </view>
    </view>
  </view>

  <!-- Bottom Action Bar -->
  <view class="bottom-action-bar safe-bottom">
    <view class="bar-icons">
      <view class="icon-btn" bindtap="goHome">
        <text class="bar-icon">🏠</text>
        <text class="bar-text">首页</text>
      </view>
      <view class="icon-btn" bindtap="goCart">
        <text class="bar-icon">🛒</text>
        <text class="bar-text">购物车</text>
        <view class="cart-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </view>
      <button class="icon-btn contact-btn" open-type="contact">
        <text class="bar-icon">💬</text>
        <text class="bar-text">客服</text>
      </button>
    </view>

    <view class="bar-buttons">
      <view class="bar-btn secondary" bindtap="showSkuModal">加入购物车</view>
      <view class="bar-btn primary" bindtap="showSkuModal">立即购买</view>
    </view>
  </view>
</view>
