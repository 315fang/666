<!--pages/product/detail.wxml - 轻奢风商品详情页-->
<view class="container">
  <!-- 1. 浮动导航栏 -->
  <view class="nav-float-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-actions">
      <view class="nav-btn-circle" bindtap="onBackTap">
        <image class="nav-icon-img" src="/assets/icons/arrow-left.svg" mode="aspectFit"/>
      </view>
      <view class="nav-right-actions">
        <button class="nav-btn-circle {{isFavorite ? 'active' : ''}}" bindtap="onToggleFavorite">
          <image class="nav-icon-img {{isFavorite ? 'filled' : ''}}" src="/assets/icons/heart.svg" mode="aspectFit"/>
        </button>
        <button class="nav-btn-circle" open-type="share">
          <image class="nav-icon-img" src="/assets/icons/share.svg" mode="aspectFit"/>
        </button>
      </view>
    </view>
  </view>

  <!-- 2. 商品图库 -->
  <view class="gallery-section">
    <swiper class="gallery-swiper" indicator-dots="{{true}}" autoplay="{{true}}" circular="{{true}}" 
            indicator-color="rgba(250,250,249,0.4)" indicator-active-color="#CA8A04"
            bindchange="onImageChange">
      <swiper-item wx:for="{{product.images}}" wx:key="*this">
        <image src="{{item}}" mode="aspectFill" class="gallery-image" bindtap="onPreviewImage" data-src="{{item}}"></image>
      </swiper-item>
    </swiper>
    <view class="gallery-count">{{currentImage + 1}}/{{imageCount}}</view>
  </view>

  <!-- 3. 商品信息卡片 -->
  <view class="product-info-card">
    <!-- 价格区域 -->
    <view class="price-section">
      <view class="price-main">
        <text class="price-symbol">¥</text>
        <text class="price-value">{{currentPrice || product.displayPrice || product.price}}</text>
      </view>
      <view class="price-origin" wx:if="{{product.market_price}}">¥{{product.market_price}}</view>
      <view class="price-discount" wx:if="{{product.market_price}}">{{discount}}折</view>
    </view>

    <!-- 销量和收藏 -->
    <view class="stats-row">
      <view class="stat-item">
        <image class="stat-icon" src="/assets/icons/shopping-bag.svg" mode="aspectFit"/>
        <text class="stat-text">已售 {{product.sales_count || 0}}</text>
      </view>
      <view class="stat-divider"></view>
      <view class="stat-item">
        <image class="stat-icon" src="/assets/icons/heart.svg" mode="aspectFit"/>
        <text class="stat-text">{{product.favorite_count || 0}}人收藏</text>
      </view>
    </view>

    <!-- 商品标题 -->
    <view class="product-title">{{product.name}}</view>

    <!-- 服务标签 -->
    <view class="tags-row">
      <view class="tag tag-blue">
        <image class="tag-icon" src="/assets/icons/shield.svg" mode="aspectFit"/>
        <text>官方正品</text>
      </view>
      <view class="tag tag-green">
        <image class="tag-icon" src="/assets/icons/truck.svg" mode="aspectFit"/>
        <text>极速发货</text>
      </view>
      <view class="tag tag-orange">
        <image class="tag-icon" src="/assets/icons/refresh-cw.svg" mode="aspectFit"/>
        <text>七天退换</text>
      </view>
    </view>

    <!-- 代理佣金条 -->
    <view class="commission-bar" wx:if="{{isAgent && commission > 0}}" bindtap="onShareAppMessage">
      <view class="commission-left">
        <view class="commission-icon-wrap">
          <image class="commission-icon" src="/assets/icons/gift.svg" mode="aspectFit"/>
        </view>
        <view class="commission-info">
          <text class="commission-text">分享赚 ¥{{commission}}</text>
          <text class="commission-sub">好友下单您可获得佣金</text>
        </view>
      </view>
      <view class="commission-arrow">
        <image class="icon-sm" src="/assets/icons/arrow-right.svg" mode="aspectFit"/>
      </view>
    </view>
  </view>

  <!-- 4. 服务保障 -->
  <view class="section-card service-section">
    <view class="service-title">服务保障</view>
    <view class="service-grid">
      <view class="service-item">
        <view class="service-icon-wrap">
          <image class="service-icon" src="/assets/icons/check-circle.svg" mode="aspectFit"/>
        </view>
        <text class="service-text">正品保障</text>
      </view>
      <view class="service-item">
        <view class="service-icon-wrap">
          <image class="service-icon" src="/assets/icons/truck.svg" mode="aspectFit"/>
        </view>
        <text class="service-text">极速发货</text>
      </view>
      <view class="service-item">
        <view class="service-icon-wrap">
          <image class="service-icon" src="/assets/icons/headphones.svg" mode="aspectFit"/>
        </view>
        <text class="service-text">售后无忧</text>
      </view>
      <view class="service-item">
        <view class="service-icon-wrap">
          <image class="service-icon" src="/assets/icons/package.svg" mode="aspectFit"/>
        </view>
        <text class="service-text">运费险</text>
      </view>
    </view>
  </view>

  <!-- 5. 规格选择 -->
  <view class="section-card spec-selector" bindtap="showSkuModal">
    <view class="selector-left">
      <text class="selector-label">规格</text>
      <text class="selector-value">{{selectedSkuText || '请选择规格数量'}}</text>
    </view>
    <view class="selector-arrow">
      <image class="icon-sm" src="/assets/icons/arrow-right.svg" mode="aspectFit"/>
    </view>
  </view>

  <!-- 6. 评价预览 -->
  <view class="section-card reviews-section" wx:if="{{reviews.length > 0}}">
    <view class="section-header">
      <view class="section-title-wrap">
        <text class="section-title">用户评价</text>
        <text class="review-count">({{reviewTotal}})</text>
      </view>
      <view class="section-more" bindtap="goReviews">
        <text>查看全部</text>
        <image class="icon-xs" src="/assets/icons/arrow-right.svg" mode="aspectFit"/>
      </view>
    </view>
    <view class="review-tags" wx:if="{{reviewTags.length > 0}}">
      <view class="review-tag" wx:for="{{reviewTags}}" wx:key="*this">{{item}}</view>
    </view>
    <view class="review-list">
      <view class="review-item" wx:for="{{reviews}}" wx:key="id" wx:if="{{index < 2}}">
        <view class="review-header">
          <image class="review-avatar" src="{{item.user.avatar_url || '/assets/icons/user.svg'}}"></image>
          <view class="review-user-info">
            <text class="review-name">{{item.user.nickname}}</text>
            <view class="review-stars">
              <image wx:for="{{[1,2,3,4,5]}}" wx:for-item="star" wx:key="*this" 
                     class="star-icon {{star <= item.rating ? 'filled' : ''}}" 
                     src="/assets/icons/star.svg" mode="aspectFit"/>
            </view>
          </view>
          <text class="review-date">{{item.created_at}}</text>
        </view>
        <text class="review-content">{{item.content}}</text>
      </view>
    </view>
  </view>

  <!-- 7. 商品详情 -->
  <view class="section-card detail-section">
    <view class="section-title-bar">
      <view class="title-line"></view>
      <text class="section-title">商品详情</text>
      <view class="title-line"></view>
    </view>
    <view class="detail-content">
      <rich-text nodes="{{product.detail_html || '暂无详情'}}"></rich-text>
    </view>
  </view>

  <!-- 8. 底部安全区域占位 -->
  <view class="bottom-safe-area"></view>

  <!-- SKU弹窗 -->
  <view class="sku-modal {{showSku ? 'show' : ''}}" bindtap="hideSkuModal">
    <view class="sku-content" catchtap="stopP">
      <view class="sku-header">
        <image src="{{selectedSkuImg || product.images[0]}}" mode="aspectFill" class="sku-thumb"></image>
        <view class="sku-info">
          <view class="sku-price">¥{{currentPrice || product.displayPrice || product.price}}</view>
          <view class="sku-stock">库存 {{currentStock || product.stock || 999}}件</view>
          <view class="sku-selected">已选 {{selectedSkuText || '请选择'}}</view>
        </view>
        <view class="close-btn" bindtap="hideSkuModal">
          <image class="icon-md" src="/assets/icons/x.svg" mode="aspectFit"/>
        </view>
      </view>

      <scroll-view scroll-y class="sku-scroll">
        <!-- 规格循环 -->
        <view class="spec-group" wx:for="{{product.specs}}" wx:key="name">
          <view class="spec-title">{{item.name}}</view>
          <view class="spec-options">
            <view class="spec-option {{selectedSpecs[item.name] === val ? 'active' : ''}}"
                  wx:for="{{item.values}}" wx:for-item="val" wx:key="*this"
                  bindtap="onSpecSelect" data-key="{{item.name}}" data-val="{{val}}">
              {{val}}
            </view>
          </view>
        </view>

        <!-- 数量选择 -->
        <view class="qty-section">
          <text class="qty-label">数量</text>
          <view class="stepper">
            <view class="stepper-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="onMinus">
              <image class="icon-xs" src="/assets/icons/minus.svg" mode="aspectFit"/>
            </view>
            <input class="stepper-input" type="number" value="{{quantity}}" bindinput="onQtyInput" />
            <view class="stepper-btn" bindtap="onPlus">
              <image class="icon-xs" src="/assets/icons/plus.svg" mode="aspectFit"/>
            </view>
          </view>
        </view>
      </scroll-view>

      <view class="sku-footer">
        <view class="sku-btn-group">
          <view class="sku-btn sku-btn-cart" bindtap="onAddToCart">
            <image class="btn-icon" src="/assets/icons/shopping-cart.svg" mode="aspectFit"/>
            <text>加入购物车</text>
          </view>
          <view class="sku-btn sku-btn-buy" bindtap="onBuyNow">
            <text>立即购买</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="action-bar">
    <view class="action-icons">
      <view class="action-icon" bindtap="goHome">
        <image class="icon-img" src="/assets/icons/home.svg" mode="aspectFit"></image>
        <text class="icon-label">首页</text>
      </view>
      <view class="action-icon" bindtap="goCart">
        <image class="icon-img" src="/assets/icons/shopping-cart.svg" mode="aspectFit"></image>
        <text class="icon-label">购物车</text>
        <view class="icon-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </view>
      <button class="action-icon" bindtap="goAIChat">
        <image class="icon-img" src="/assets/icons/sparkles.svg" mode="aspectFit"></image>
        <text class="icon-label">AI咨询</text>
      </button>
    </view>
    <view class="action-buttons">
      <view class="action-btn action-btn-cart" bindtap="onAddToCart">
        <text>加入购物车</text>
      </view>
      <view class="action-btn action-btn-buy" bindtap="onBuyNow">
        <text>立即购买</text>
      </view>
    </view>
  </view>
</view>
