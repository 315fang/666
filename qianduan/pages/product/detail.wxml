<!--pages/product/detail.wxml - æˆç†Ÿç”µå•†é£æ ¼-->
<view class="container">
  <!-- 1. Floating Nav Bar -->
  <view class="nav-float-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-actions">
      <view class="nav-btn-circle" bindtap="onBackTap">
        <text class="nav-icon">â†</text>
      </view>
      <view class="nav-right-actions">
        <button class="nav-btn-circle" bindtap="onToggleFavorite">
          <text class="nav-icon {{isFavorite ? 'filled' : ''}}">â™¥</text>
        </button>
        <button class="nav-btn-circle" open-type="share">
          <text class="nav-icon">â†—</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 2. Product Gallery -->
  <view class="gallery-section">
    <swiper class="gallery-swiper" indicator-dots="{{true}}" autoplay="{{true}}" circular="{{true}}" indicator-color="rgba(255,255,255,0.4)" indicator-active-color="#ffffff">
      <swiper-item wx:for="{{product.images}}" wx:key="*this">
        <image src="{{item}}" mode="aspectFill" class="gallery-image" bindtap="onPreviewImage" data-src="{{item}}"></image>
      </swiper-item>
    </swiper>
    <view class="gallery-count">{{currentImage + 1}}/{{imageCount}}</view>
  </view>

  <!-- 3. Product Info Card -->
  <view class="product-card">
    <!-- Price Section -->
    <view class="price-section">
      <view class="price-main">
        <text class="price-symbol">Â¥</text>
        <text class="price-value">{{currentPrice || product.displayPrice || product.price}}</text>
      </view>
      <view class="price-origin" wx:if="{{product.market_price}}">Â¥{{product.market_price}}</view>
      <view class="price-discount" wx:if="{{product.market_price}}">
        {{discount}}æŠ˜
      </view>
    </view>

    <!-- Sales & Favorites -->
    <view class="stats-row">
      <text class="stats-item">å·²å”® {{product.sales_count || 0}}ä»¶</text>
      <text class="stats-divider">|</text>
      <text class="stats-item">{{product.favorite_count || 0}}äººæ”¶è—</text>
    </view>

    <!-- Title -->
    <view class="product-title">{{product.name}}</view>

    <!-- Tags -->
    <view class="tags-row">
      <view class="tag tag-blue">å®˜æ–¹æ­£å“</view>
      <view class="tag tag-green">æé€Ÿå‘è´§</view>
      <view class="tag tag-orange">ä¸ƒå¤©é€€æ¢</view>
    </view>

    <!-- Agent Commission -->
    <view class="commission-bar" wx:if="{{isAgent && commission > 0}}">
      <view class="commission-left">
        <text class="commission-icon">ğŸ’°</text>
        <text class="commission-text">åˆ†äº«èµš Â¥{{commission}}</text>
      </view>
      <text class="commission-arrow">â€º</text>
    </view>
  </view>

  <!-- 4. Service Section -->
  <view class="section-card">
    <view class="service-grid">
      <view class="service-item">
        <text class="service-icon">âœ“</text>
        <text class="service-text">æ­£å“ä¿éšœ</text>
      </view>
      <view class="service-item">
        <text class="service-icon">âœ“</text>
        <text class="service-text">æé€Ÿå‘è´§</text>
      </view>
      <view class="service-item">
        <text class="service-icon">âœ“</text>
        <text class="service-text">å”®åæ— å¿§</text>
      </view>
      <view class="service-item">
        <text class="service-icon">âœ“</text>
        <text class="service-text">è¿è´¹é™©</text>
      </view>
    </view>
  </view>

  <!-- 5. Spec Selector -->
  <view class="section-card spec-selector" bindtap="showSkuModal">
    <view class="selector-content">
      <text class="selector-label">è§„æ ¼</text>
      <text class="selector-value">{{selectedSkuText || 'è¯·é€‰æ‹©è§„æ ¼æ•°é‡'}}</text>
    </view>
    <text class="selector-arrow">â€º</text>
  </view>

  <!-- 6. Reviews Preview -->
  <view class="section-card reviews-section" wx:if="{{reviews.length > 0}}">
    <view class="section-header">
      <view class="section-title">
        <text>ç”¨æˆ·è¯„ä»·</text>
        <text class="review-count">({{reviewTotal}})</text>
      </view>
      <view class="section-more" bindtap="goReviews">
        <text>æŸ¥çœ‹å…¨éƒ¨</text>
        <text>â€º</text>
      </view>
    </view>
    <view class="review-tags" wx:if="{{reviewTags.length > 0}}">
      <text class="review-tag" wx:for="{{reviewTags}}" wx:key="*this">{{item}}</text>
    </view>
    <view class="review-item" wx:for="{{reviews}}" wx:key="id" wx:if="{{index < 2}}">
      <view class="review-header">
        <image class="review-avatar" src="{{item.user.avatar_url || '/assets/icons/user.svg'}}"></image>
        <text class="review-name">{{item.user.nickname}}</text>
        <view class="review-stars">
          <text wx:for="{{[1,2,3,4,5]}}" wx:for-item="star" wx:key="*this" class="star {{star <= item.rating ? 'filled' : ''}}">â˜…</text>
        </view>
      </view>
      <text class="review-content">{{item.content}}</text>
    </view>
  </view>

  <!-- 7. Product Details -->
  <view class="section-card detail-section">
    <view class="section-title-bar">
      <text class="section-title">å•†å“è¯¦æƒ…</text>
    </view>
    <view class="detail-content">
      <rich-text nodes="{{product.detail_html || 'æš‚æ— è¯¦æƒ…'}}"></rich-text>
    </view>
  </view>

  <!-- SKU Modal -->
  <view class="sku-modal {{showSku ? 'show' : ''}}" bindtap="hideSkuModal">
    <view class="sku-content" catchtap="stopP">
      <view class="sku-header">
        <image src="{{selectedSkuImg || product.images[0]}}" mode="aspectFill" class="sku-thumb"></image>
        <view class="sku-info">
          <view class="sku-price">Â¥{{currentPrice || product.displayPrice || product.price}}</view>
          <view class="sku-stock">åº“å­˜ {{currentStock || product.stock || 999}}ä»¶</view>
          <view class="sku-selected">å·²é€‰ {{selectedSkuText || 'è¯·é€‰æ‹©'}}</view>
        </view>
        <view class="close-btn" bindtap="hideSkuModal">âœ•</view>
      </view>

      <scroll-view scroll-y class="sku-scroll">
        <!-- Specs Loop -->
        <view class="spec-group" wx:for="{{product.specs}}" wx:key="name">
          <view class="spec-title">{{item.name}}</view>
          <view class="spec-options">
            <view class="spec-option {{selectedSpecs[item.name] === val ? 'active' : ''}}"
                  wx:for="{{item.values}}" wx:for-item="val" wx:key="*this"
                  bindtap="onSpecSelect" data-key="{{item.name}}" data-val="{{val}}">
              {{val}}
            </view>
          </view>
        </view>

        <!-- Quantity -->
        <view class="qty-section">
          <text class="qty-label">æ•°é‡</text>
          <view class="stepper">
            <view class="stepper-btn {{quantity <= 1 ? 'disabled' : ''}}" bindtap="onMinus">âˆ’</view>
            <input class="stepper-input" type="number" value="{{quantity}}" bindinput="onQtyInput" />
            <view class="stepper-btn" bindtap="onPlus">+</view>
          </view>
        </view>
      </scroll-view>

      <view class="sku-footer">
        <view class="sku-btn-group">
          <view class="sku-btn sku-btn-cart" bindtap="onAddToCart">åŠ å…¥è´­ç‰©è½¦</view>
          <view class="sku-btn sku-btn-buy" bindtap="onBuyNow">ç«‹å³è´­ä¹°</view>
        </view>
      </view>
    </view>
  </view>

  <!-- Bottom Action Bar -->
  <view class="action-bar">
    <view class="action-icons">
      <view class="action-icon" bindtap="goHome">
        <image class="icon-img" src="/assets/icons/home.svg" mode="aspectFit"></image>
        <text class="icon-label">é¦–é¡µ</text>
      </view>
      <view class="action-icon" bindtap="goCart">
        <image class="icon-img" src="/assets/icons/cart.svg" mode="aspectFit"></image>
        <text class="icon-label">è´­ç‰©è½¦</text>
        <view class="icon-badge" wx:if="{{cartCount > 0}}">{{cartCount}}</view>
      </view>
      <button class="action-icon" open-type="contact">
        <image class="icon-img" src="/assets/icons/message.svg" mode="aspectFit"></image>
        <text class="icon-label">å®¢æœ</text>
      </button>
    </view>
    <view class="action-buttons">
      <view class="action-btn action-btn-secondary" bindtap="onAddToCart">åŠ å…¥è´­ç‰©è½¦</view>
      <view class="action-btn action-btn-primary" bindtap="onBuyNow">ç«‹å³è´­ä¹°</view>
    </view>
  </view>
</view>
