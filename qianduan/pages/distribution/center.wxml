<!--pages/distribution/center.wxml - åˆ†ä½£ä¸­å¿ƒï¼ˆæ•´åˆé’±åŒ…ã€é‚€è¯·ã€ä½£é‡‘æ˜ç»†ï¼‰-->
<view class="container">
  <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
  <view class="user-card">
    <image class="user-avatar" src="{{userInfo.avatar_url || ''}}" mode="aspectFill" wx:if="{{userInfo.avatar_url}}"></image>
    <view class="user-avatar-default" wx:else>
      <text>{{userInfo.nickname ? userInfo.nickname[0] : 'è‡»'}}</text>
    </view>
    <view class="user-info">
      <view class="user-name">
        <text>{{userInfo.nickname || 'å¾®ä¿¡ç”¨æˆ·'}}</text>
        <text class="user-level">{{userInfo.role_name || 'æ™®é€šç”¨æˆ·'}}</text>
      </view>
      <view class="inviter-info" wx:if="{{hasParent && parentInfo}}">
        <text>é‚€è¯·äºº: {{parentInfo.nickname}}</text>
      </view>
      <view class="inviter-info bind-invite-entry" bindtap="onBindInviteTap" wx:else>
        <text>æœªç»‘å®šä¸Šçº§ï¼Œç‚¹å‡»å¡«å†™é‚€è¯·ç  â†’</text>
      </view>
    </view>
    <!-- é€šçŸ¥é“ƒé“› -->
    <view class="notif-bell" bindtap="onNotificationsTap">
      <text class="bell-icon">ğŸ””</text>
      <view class="notif-badge" wx:if="{{unreadCount > 0}}">{{unreadCount > 99 ? '99+' : unreadCount}}</view>
    </view>
  </view>

  <!-- èµ„é‡‘æ€»è§ˆå¡ç‰‡ -->
  <view class="header-card">
    <view class="header-main">
      <view class="total-label">ç´¯è®¡ä½£é‡‘(å…ƒ)</view>
      <view class="total-amount">{{stats.totalEarnings || '0.00'}}</view>
    </view>
    <view class="header-sub">
      <view class="sub-item">
        <text class="sub-label">å¯æç°ä½™é¢</text>
        <text class="sub-value">Â¥{{balance || '0.00'}}</text>
      </view>
      <view class="sub-item">
        <text class="sub-label">å¾…ç»“ç®—</text>
        <text class="sub-value">Â¥{{stats.frozenAmount || '0.00'}}</text>
      </view>
    </view>
    <view class="withdraw-btn" bindtap="onWithdrawTap">ç«‹å³æç°</view>
  </view>

  <!-- åŠŸèƒ½èœå• -->
  <view class="menu-grid">
    <view class="menu-item" bindtap="onTeamTap">
      <view class="menu-icon team-icon">ğŸ‘¥</view>
      <view class="menu-text">æˆ‘çš„å›¢é˜Ÿ</view>
      <view class="menu-sub">{{team.totalCount || 0}}äºº</view>
    </view>
    <view class="menu-item" bindtap="onOrderTap">
      <view class="menu-icon order-icon">ğŸ“œ</view>
      <view class="menu-text">åˆ†é”€è®¢å•</view>
      <view class="menu-sub">æŸ¥çœ‹æ˜ç»†</view>
    </view>
    <view class="menu-item" bindtap="onRefundTap">
      <view class="menu-icon refund-icon">ğŸ”„</view>
      <view class="menu-text">é€€è´§ç®¡ç†</view>
      <view class="menu-sub">å”®åå¤„ç†</view>
    </view>
    <button class="menu-item share-menu-btn" open-type="share">
      <view class="menu-icon code-icon">ğŸ“·</view>
      <view class="menu-text">é‚€è¯·å¥½å‹</view>
      <view class="menu-sub">åˆ†äº«èµšé’±</view>
    </button>
  </view>

  <!-- ä»£ç†å•†ä¸“å±åŠŸèƒ½åŒºï¼ˆä»…ä»£ç†å•†å¯è§ï¼‰ -->
  <view class="agent-section" wx:if="{{isAgent}}">
    <view class="section-header">
      <text class="section-title">ğŸ­ ä»£ç†å•†ä¸“åŒº</text>
      <text class="section-badge">ä»£ç†å•†</text>
    </view>
    <!-- äº‘ä»“åº“å­˜æ¦‚è§ˆ -->
    <view class="agent-stock-card">
      <view class="stock-overview">
        <view class="stock-big-number">{{agentStock || 0}}</view>
        <view class="stock-unit">äº‘ä»“åº“å­˜(ä»¶)</view>
      </view>
      <view class="stock-mini-stats">
        <view class="mini-stat">
          <text class="mini-value">{{agentPending || 0}}</text>
          <text class="mini-label">å¾…å‘è´§</text>
        </view>
        <view class="mini-stat">
          <text class="mini-value">Â¥{{agentMonthProfit || '0.00'}}</text>
          <text class="mini-label">æœ¬æœˆåˆ©æ¶¦</text>
        </view>
      </view>
    </view>
    <!-- ä»£ç†å•†åŠŸèƒ½å…¥å£ -->
    <view class="agent-menu">
      <view class="agent-menu-item" bindtap="goWorkbench">
        <view class="agent-menu-icon" style="background:#EEF2FF;">ğŸšš</view>
        <view class="agent-menu-info">
          <text class="agent-menu-title">å‘è´§å·¥ä½œå°</text>
          <text class="agent-menu-desc">å¤„ç†è®¢å•ã€å¡«å†™ç‰©æµ</text>
        </view>
        <view class="agent-menu-badge" wx:if="{{agentPending > 0}}">{{agentPending}}</view>
        <text class="agent-menu-arrow">â€º</text>
      </view>
      <view class="agent-menu-item" bindtap="goRestock">
        <view class="agent-menu-icon" style="background:#FFF7ED;">ğŸ“¦</view>
        <view class="agent-menu-info">
          <text class="agent-menu-title">é‡‡è´­å…¥ä»“</text>
          <text class="agent-menu-desc">è¡¥å……äº‘ä»“åº“å­˜</text>
        </view>
        <text class="agent-menu-arrow">â€º</text>
      </view>
      <view class="agent-menu-item" bindtap="goStockLogs">
        <view class="agent-menu-icon" style="background:#ECFDF5;">ğŸ“‹</view>
        <view class="agent-menu-info">
          <text class="agent-menu-title">åº“å­˜æ˜ç»†</text>
          <text class="agent-menu-desc">å‡ºå…¥åº“è®°å½•æŸ¥è¯¢</text>
        </view>
        <text class="agent-menu-arrow">â€º</text>
      </view>
    </view>
    <!-- æ¬ æ¬¾æç¤º -->
    <view class="debt-warn" wx:if="{{agentDebt > 0}}">
      <text class="debt-icon">âš ï¸</text>
      <text class="debt-text">æ‚¨æœ‰ Â¥{{agentDebt}} å¾…è¿½å›æ¬ æ¬¾ï¼Œæ–°ä½£é‡‘å°†ä¼˜å…ˆæŠµæ‰£ï¼Œæç°æš‚æ—¶å†»ç»“</text>
    </view>
  </view>

  <!-- æœ€è¿‘é€šçŸ¥ -->
  <view class="notif-card" wx:if="{{latestNotifications.length > 0}}">
    <view class="notif-card-header" bindtap="onNotificationsTap">
      <text class="notif-card-title">ğŸ“¢ æœ€æ–°æ¶ˆæ¯</text>
      <text class="notif-card-more">æŸ¥çœ‹å…¨éƒ¨ â€º</text>
    </view>
    <view class="notif-card-list">
      <view class="notif-card-item {{item.is_read ? '' : 'unread'}}" wx:for="{{latestNotifications}}" wx:key="id" wx:if="{{index < 3}}">
        <view class="notif-card-dot" wx:if="{{!item.is_read}}"></view>
        <text class="notif-card-content">{{item.title}}: {{item.content}}</text>
        <text class="notif-card-time">{{item.time_format}}</text>
      </view>
    </view>
  </view>

  <!-- é‚€è¯·ç  + ç»‘å®šé‚€è¯·ç  -->
  <view class="invite-card">
    <view class="invite-title">æˆ‘çš„é‚€è¯·ç </view>
    <view class="invite-code">{{inviteCode || 'ç™»å½•åæŸ¥çœ‹'}}</view>
    <view class="invite-actions">
      <view class="invite-btn" bindtap="onCopyInviteCode">å¤åˆ¶é‚€è¯·ç </view>
      <button class="invite-btn primary" open-type="share">åˆ†äº«ç»™å¥½å‹</button>
    </view>
    <view class="invite-tips">å¥½å‹é€šè¿‡æ‚¨çš„åˆ†äº«è¿›å…¥å°ç¨‹åºå³å¯è‡ªåŠ¨ç»‘å®šå…³ç³»</view>
    <!-- å¡«å†™ä»–äººé‚€è¯·ç  -->
    <view class="bind-invite-row" wx:if="{{!hasParent}}">
      <view class="bind-invite-divider"></view>
      <view class="bind-invite-btn" bindtap="onBindInviteTap">
        <text>ğŸ“ æˆ‘æœ‰é‚€è¯·ç ï¼Œç‚¹å‡»å¡«å†™åŠ å…¥å›¢é˜Ÿ</text>
      </view>
    </view>
  </view>

  <!-- Tabåˆ‡æ¢ï¼šä½£é‡‘æ˜ç»† / æç°è®°å½• -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'overview' ? 'active' : ''}}" data-tab="overview" bindtap="onTabChange">
      ä½£é‡‘æ˜ç»†
    </view>
    <view class="tab-item {{activeTab === 'withdraw' ? 'active' : ''}}" data-tab="withdraw" bindtap="onTabChange">
      æç°è®°å½•
    </view>
  </view>

  <!-- ä½£é‡‘æ˜ç»†åˆ—è¡¨ -->
  <view class="list-section" wx:if="{{activeTab === 'overview'}}">
    <view class="log-list">
      <view class="log-item" wx:for="{{commissionLogs}}" wx:key="id">
        <view class="log-info">
          <text class="log-type">{{item.typeName}}</text>
          <text class="log-status {{item.statusClass}}">{{item.statusText}}</text>
          <text class="log-time">{{item.created_at}}</text>
        </view>
        <view class="log-amount income">+{{item.amount}}</view>
        <view class="log-remark" wx:if="{{item.remark}}" style="font-size: 20rpx; color: #999; margin-top: 4rpx; width: 100%;">{{item.remark}}</view>
      </view>
      <view class="empty" wx:if="{{commissionLogs.length === 0}}">
        <text class="empty-text">æš‚æ— ä½£é‡‘è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- æç°è®°å½•åˆ—è¡¨ -->
  <view class="list-section" wx:if="{{activeTab === 'withdraw'}}">
    <view class="log-list">
      <view class="log-item" wx:for="{{withdrawals}}" wx:key="id">
        <view class="log-info">
          <text class="log-type">æç° Â¥{{item.amount}}</text>
          <text class="log-status {{item.statusClass}}">{{item.statusText}}</text>
          <text class="log-time">{{item.created_at}}</text>
        </view>
        <view class="log-amount expense">-{{item.actual_amount || item.amount}}</view>
        <view class="log-remark" wx:if="{{item.reject_reason}}" style="font-size: 20rpx; color: #ff4d4f; margin-top: 4rpx; width: 100%;">æ‹’ç»åŸå› : {{item.reject_reason}}</view>
      </view>
      <view class="empty" wx:if="{{withdrawals.length === 0}}">
        <text class="empty-text">æš‚æ— æç°è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- æç°å¼¹çª— -->
  <view class="withdraw-popup {{showWithdraw ? 'show' : ''}}">
    <view class="mask" bindtap="hideWithdraw"></view>
    <view class="popup-content">
      <view class="popup-title">ç”³è¯·æç°</view>
      <view class="popup-balance">å½“å‰å¯æç°ä½™é¢ï¼šÂ¥{{balance}}</view>
      <input class="popup-input" type="digit" placeholder="è¯·è¾“å…¥æç°é‡‘é¢" bindinput="onWithdrawInput" value="{{withdrawAmount}}" />
      <button class="popup-btn" bindtap="confirmWithdraw">ç¡®è®¤æç°</button>
    </view>
  </view>

  <!-- ç»‘å®šé‚€è¯·ç å¼¹çª— -->
  <view class="withdraw-popup {{showBindInvite ? 'show' : ''}}">
    <view class="mask" bindtap="hideBindInvite"></view>
    <view class="popup-content">
      <view class="popup-title">å¡«å†™é‚€è¯·ç </view>
      <view class="popup-balance">è¾“å…¥æ¨èäººçš„é‚€è¯·ç åŠ å…¥å›¢é˜Ÿï¼Œç»‘å®šåä¸å¯æ›´æ”¹</view>
      <input class="popup-input" type="text" placeholder="è¯·è¾“å…¥6ä½é‚€è¯·ç " bindinput="onBindInviteInput" value="{{bindInviteCode}}" maxlength="6" />
      <button class="popup-btn" bindtap="confirmBindInvite">ç¡®è®¤ç»‘å®š</button>
    </view>
  </view>
</view>
