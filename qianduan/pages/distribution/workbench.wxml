<!--pages/distribution/workbench.wxml - ä»£ç†å•†å‘è´§å·¥ä½œå°-->
<view class="container">
  <!-- äº‘ä»“çŠ¶æ€å¡ç‰‡ -->
  <view class="stock-card">
    <view class="stock-main">
      <view class="stock-number">{{workbench.stock_count || 0}}</view>
      <view class="stock-label">äº‘ä»“åº“å­˜(ä»¶)</view>
    </view>
    <view class="stock-stats">
      <view class="stat-item">
        <text class="stat-value">{{workbench.pending_ship || 0}}</text>
        <text class="stat-label">å¾…å‘è´§</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{workbench.pending_confirm || 0}}</text>
        <text class="stat-label">å¾…ç¡®è®¤</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{workbench.total_handled || 0}}</text>
        <text class="stat-label">ç´¯è®¡å‘è´§</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">Â¥{{workbench.month_profit || '0.00'}}</text>
        <text class="stat-label">æœ¬æœˆåˆ©æ¶¦</text>
      </view>
    </view>
    <view class="stock-actions">
      <view class="stock-btn" bindtap="goRestock">ğŸ“¦ é‡‡è´­å…¥ä»“</view>
      <view class="stock-btn outline" bindtap="goStockLogs">ğŸ“‹ åº“å­˜æ˜ç»†</view>
    </view>
  </view>

  <!-- è®¢å•ç­›é€‰ Tab -->
  <view class="tab-bar">
    <view class="tab-item {{activeStatus === 'pending' ? 'active' : ''}}" data-status="pending" bindtap="onStatusChange">
      å¾…å‘è´§
      <view class="tab-badge" wx:if="{{workbench.pending_ship > 0}}">{{workbench.pending_ship}}</view>
    </view>
    <view class="tab-item {{activeStatus === 'shipping_requested' ? 'active' : ''}}" data-status="shipping_requested" bindtap="onStatusChange">
      å¾…ç¡®è®¤
    </view>
    <view class="tab-item {{activeStatus === 'shipped' ? 'active' : ''}}" data-status="shipped" bindtap="onStatusChange">
      å·²å‘è´§
    </view>
    <view class="tab-item {{activeStatus === 'all' ? 'active' : ''}}" data-status="all" bindtap="onStatusChange">
      å…¨éƒ¨
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card" wx:for="{{orders}}" wx:key="id">
      <view class="order-header">
        <text class="order-no">{{item.order_no}}</text>
        <text class="order-status status-{{item.status}}">
          {{item.status === 'paid' ? 'å¾…å‘è´§' : item.status === 'agent_confirmed' ? 'å·²ç¡®è®¤' : item.status === 'shipping_requested' ? 'å¾…å¹³å°ç¡®è®¤' : item.status === 'shipped' ? 'å·²å‘è´§' : item.status === 'completed' ? 'å·²å®Œæˆ' : item.status}}
        </text>
      </view>

      <view class="order-product">
        <image class="product-img" src="{{item.product.images[0] || ''}}" mode="aspectFill" wx:if="{{item.product && item.product.images}}"></image>
        <view class="product-info">
          <text class="product-name">{{item.product.name || 'å•†å“'}}</text>
          <view class="product-meta">
            <text>ä¹°å®¶: {{item.buyer.nickname || 'ç”¨æˆ·'}}</text>
            <text>Ã—{{item.quantity}}</text>
          </view>
          <text class="product-price">å®ä»˜ Â¥{{item.actual_price || item.total_amount}}</text>
        </view>
      </view>

      <!-- æ”¶è´§åœ°å€ -->
      <view class="order-address" wx:if="{{item.address_snapshot}}">
        <text class="address-icon">ğŸ“</text>
        <text class="address-text">{{item.address_snapshot.receiver_name}} {{item.address_snapshot.phone}} | {{item.address_snapshot.province}}{{item.address_snapshot.city}}{{item.address_snapshot.district}}{{item.address_snapshot.detail}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="order-actions" wx:if="{{item.status === 'paid' || item.status === 'agent_confirmed'}}">
        <view class="action-btn primary" data-id="{{item.id}}" data-order="{{item}}" bindtap="onShipTap">
          ğŸšš å¡«å•å·å‘è´§
        </view>
      </view>
      <view class="order-actions" wx:if="{{item.status === 'shipped' || item.status === 'completed'}}">
        <text class="tracking-info">ç‰©æµ: {{item.tracking_no || 'æ— '}}</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:if="{{orders.length === 0 && !loading}}">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- å‘è´§å¼¹çª— -->
  <view class="ship-popup {{showShipPopup ? 'show' : ''}}">
    <view class="mask" bindtap="hideShipPopup"></view>
    <view class="popup-content">
      <view class="popup-title">å¡«å†™å‘è´§ä¿¡æ¯</view>
      <view class="popup-order-info">
        è®¢å•: {{shipOrder.order_no || ''}} | æ•°é‡: {{shipOrder.quantity || 0}}ä»¶
      </view>
      <view class="popup-stock-info">
        å½“å‰äº‘ä»“åº“å­˜: {{workbench.stock_count || 0}}ä»¶
        <text class="stock-warn" wx:if="{{workbench.stock_count < (shipOrder.quantity || 0)}}">ï¼ˆåº“å­˜ä¸è¶³ï¼ï¼‰</text>
      </view>
      <view class="form-group">
        <text class="form-label">ç‰©æµå…¬å¸</text>
        <input class="form-input" type="text" placeholder="å¦‚ï¼šé¡ºä¸°ã€åœ†é€šã€ä¸­é€š" bindinput="onCompanyInput" value="{{shipCompany}}" />
      </view>
      <view class="form-group">
        <text class="form-label">ç‰©æµå•å·</text>
        <input class="form-input" type="text" placeholder="è¯·è¾“å…¥ç‰©æµå•å·" bindinput="onTrackingInput" value="{{shipTrackingNo}}" />
      </view>
      <button class="popup-btn" bindtap="confirmShip" disabled="{{!shipTrackingNo}}">ç¡®è®¤å‘è´§</button>
    </view>
  </view>
</view>
