<!--pages/distribution/workbench.wxml - å·¥å‚å‘è´§å·¥ä½œå°-->
<view class="container">
  <!-- äº‘ä»“çŠ¶æ€å¡ç‰‡ -->
  <view class="stock-card">
    <view class="stock-main">
      <view class="stock-number">{{workbench.stock_count || 0}}</view>
      <view class="stock-label">äº‘ä»“åº“å­˜(ä»¶)</view>
    </view>
    <view class="stock-stats">
      <view class="stat-item">
        <text class="stat-value">{{workbench.pending_ship || 0}}</text>
        <text class="stat-label">å¾…å‘è´§</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{workbench.pending_confirm || 0}}</text>
        <text class="stat-label">å¾…ç¡®è®¤</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{workbench.total_handled || 0}}</text>
        <text class="stat-label">ç´¯è®¡å‘è´§</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">Â¥{{workbench.month_profit || '0.00'}}</text>
        <text class="stat-label">æœ¬æœˆåˆ©æ¶¦</text>
      </view>
    </view>
    <view class="stock-actions">
      <view class="stock-btn" bindtap="goRestock">ğŸ“¦ äº‘åº“å­˜è¡¥è´§</view>
      <view class="stock-btn outline" bindtap="goStockLogs">ğŸ“‹ åº“å­˜æ˜ç»†</view>
    </view>
  </view>

  <!-- è®¢å•ç­›é€‰ Tab - è“è‰²æ»‘åŠ¨æ¡ -->
  <view class="tab-container">
    <scroll-view scroll-x scroll-with-animation show-scrollbar="{{false}}" class="tab-scroll-wrapper">
      <view class="tab-scroll">
        <view class="tab-item {{activeStatus === 'all' ? 'active' : ''}}" data-status="all" bindtap="onStatusChange">
          <text class="tab-text">å…¨éƒ¨</text>
        </view>
        <view class="tab-item {{activeStatus === 'pending' ? 'active' : ''}}" data-status="pending" bindtap="onStatusChange">
          <text class="tab-text">å¾…ç¡®è®¤</text>
          <view class="tab-badge" wx:if="{{workbench.pending_ship > 0}}">{{workbench.pending_ship}}</view>
        </view>
        <view class="tab-item {{activeStatus === 'shipped' ? 'active' : ''}}" data-status="shipped" bindtap="onStatusChange">
          <text class="tab-text">å·¥å‚å‘è´§ä¸­</text>
        </view>
        <view class="tab-item {{activeStatus === 'completed' ? 'active' : ''}}" data-status="completed" bindtap="onStatusChange">
          <text class="tab-text">å·²å®Œæˆ</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card" wx:for="{{orders}}" wx:key="id">
      <view class="order-header">
        <text class="order-no">{{item.order_no}}</text>
        <text class="order-status status-{{item.status}}">
          {{item.status === 'paid' ? 'å¾…ç¡®è®¤' : item.status === 'agent_confirmed' ? 'å·²ç¡®è®¤-ç­‰å¾…å‘è´§' : item.status === 'shipping_requested' ? 'å·¥å‚å‡†å¤‡ä¸­' : item.status === 'shipped' ? 'å·¥å‚å·²å‘è´§' : item.status === 'completed' ? 'å·²å®Œæˆ' : item.status}}
        </text>
      </view>

      <view class="order-product">
        <image class="product-img" src="{{item.product.images[0] || ''}}" mode="aspectFill" wx:if="{{item.product && item.product.images}}"></image>
        <view class="product-info">
          <text class="product-name">{{item.product.name || 'å•†å“'}}</text>
          <view class="product-meta">
            <text>ä¹°å®¶: {{item.buyer.nickname || 'ç”¨æˆ·'}}</text>
            <text>Ã—{{item.quantity}}</text>
          </view>
          <text class="product-price">å®ä»˜ Â¥{{item.actual_price || item.total_amount}}</text>
        </view>
      </view>

      <!-- æ”¶è´§åœ°å€ -->
      <view class="order-address" wx:if="{{item.address_snapshot}}">
        <text class="address-icon">ğŸ“</text>
        <text class="address-text">{{item.address_snapshot.receiver_name}} {{item.address_snapshot.phone}} | {{item.address_snapshot.province}}{{item.address_snapshot.city}}{{item.address_snapshot.district}}{{item.address_snapshot.detail}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="order-actions" wx:if="{{item.status === 'paid'}}">
        <view class="action-btn primary" data-id="{{item.id}}" data-order="{{item}}" bindtap="onConfirmTap">
          âœ… ç¡®è®¤è®¢å•
        </view>
      </view>
      <view class="order-actions" wx:if="{{item.status === 'agent_confirmed' || item.status === 'shipping_requested'}}">
        <text class="tracking-info">â³ å·¥å‚å‡†å¤‡å‘è´§ä¸­...</text>
      </view>
      <view class="order-actions" wx:if="{{item.status === 'shipped' || item.status === 'completed'}}">
        <text class="tracking-info">ğŸ“¦ ç‰©æµå•å·: {{item.tracking_no || 'å·¥å‚å½•å…¥ä¸­'}}</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty" wx:if="{{orders.length === 0 && !loading}}">
      <text class="empty-icon">ğŸ“­</text>
      <text class="empty-text">æš‚æ— è®¢å•</text>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-more" wx:if="{{loading}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- è®¢å•ç¡®è®¤å¼¹çª— -->
  <view class="ship-popup {{showShipPopup ? 'show' : ''}}">
    <view class="mask" bindtap="hideShipPopup"></view>
    <view class="popup-content">
      <view class="popup-title">ç¡®è®¤è®¢å•</view>
      <view class="ship-confirm-info" wx:if="{{shipOrder.id}}">
        <view class="info-row">
          <text class="label">æ”¶è´§äºº:</text>
          <text class="value">{{shipOrder.address_snapshot.receiver_name}} {{shipOrder.address_snapshot.phone}}</text>
        </view>
        <view class="info-row">
          <text class="label">å•†å“:</text>
          <text class="value">{{shipOrder.product.name}} Ã—{{shipOrder.quantity}}</text>
        </view>
        <view class="info-row">
          <text class="label">æ‰£é™¤äº‘åº“å­˜:</text>
          <text class="value highlight">{{shipOrder.quantity}} ä»¶</text>
        </view>
      </view>
      <view class="popup-tips">
        <text>âš ï¸ ç¡®è®¤åå°†æ‰£é™¤æ‚¨çš„äº‘åº“å­˜æ•°é‡</text>
        <text>ğŸ“¦ å·¥å‚å°†åœ¨24å°æ—¶å†…ç›´æ¥å‘è´§ç»™å®¢æˆ·</text>
        <text>ğŸšš ç‰©æµä¿¡æ¯ç”±å·¥å‚ç»Ÿä¸€ç®¡ç†å’Œå½•å…¥</text>
      </view>
      <button class="btn btn-primary btn-block" bindtap="confirmOrder">ç¡®è®¤è®¢å•</button>
    </view>
  </view>
</view>
