<!--pages/points/index.wxml - ç§¯åˆ†ä¸­å¿ƒ-->
<view class="container">
  <!-- æµ®åŠ¨å¯¼èˆª -->
  <view class="nav-bar" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-back" bindtap="onBackTap">
      <image class="nav-icon" src="/assets/icons/arrow-left.svg" mode="aspectFit"/>
    </view>
    <text class="nav-title">ç§¯åˆ†ä¸­å¿ƒ</text>
    <view class="nav-placeholder"/>
  </view>

  <!-- ä¸»å¡ç‰‡ï¼šç­‰çº§ + ç§¯åˆ† -->
  <view class="hero-card" wx:if="{{account}}">
    <!-- ç­‰çº§å¾½ç«  -->
    <view class="level-badge">
      <text class="level-text">Lv.{{account.level}}</text>
      <text class="level-name">{{account.level_name}}</text>
    </view>

    <!-- ç§¯åˆ†æ•°å€¼ -->
    <view class="points-display">
      <text class="points-num">{{account.balance_points}}</text>
      <text class="points-label">å¯ç”¨ç§¯åˆ†</text>
    </view>

    <!-- è¿›åº¦æ¡ï¼ˆåˆ°ä¸‹ä¸€çº§ï¼‰ -->
    <view class="level-progress" wx:if="{{account.next_level}}">
      <view class="progress-info">
        <text class="progress-label">è·ç¦» Lv.{{account.next_level.level}} {{account.next_level.name}}</text>
        <text class="progress-tip">è¿˜å·® {{account.next_level.points_needed}} ç§¯åˆ†</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{100 - (account.next_level.points_needed / (account.next_level.points_needed + account.balance_points)) * 100}}%;"/>
      </view>
    </view>
    <view class="level-progress" wx:else>
      <text class="progress-label">ğŸ‰ å·²è¾¾æœ€é«˜ç­‰çº§ï¼Œæ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼</text>
    </view>

    <!-- å½“å‰ç‰¹æƒ -->
    <view class="perks-row">
      <view class="perk-tag" wx:for="{{account.level_perks}}" wx:key="*this">
        <image class="perk-icon" src="/assets/icons/check-circle.svg" mode="aspectFit"/>
        <text>{{item}}</text>
      </view>
    </view>
  </view>

  <!-- éª¨æ¶å± -->
  <view class="hero-card skeleton" wx:if="{{loading && !account}}">
    <view class="sk-line sk-wide"/>
    <view class="sk-line sk-medium" style="margin-top:16rpx;"/>
  </view>

  <!-- ç­¾åˆ°æŒ‰é’® -->
  <view class="checkin-section" wx:if="{{tasks.length > 0}}">
    <view class="checkin-card" bindtap="onCheckin">
      <view class="checkin-left">
        <image class="checkin-icon" src="/assets/icons/star.svg" mode="aspectFit"/>
        <view class="checkin-info">
          <text class="checkin-title">æ¯æ—¥ç­¾åˆ°</text>
          <text class="checkin-streak" wx:if="{{tasks[0] && tasks[0].streak > 0}}">
            å·²è¿ç»­ç­¾åˆ° {{tasks[0].streak}} å¤© ğŸ”¥
          </text>
          <text class="checkin-streak" wx:else>ä»Šæ—¥æœªç­¾åˆ°</text>
        </view>
      </view>
      <view class="checkin-btn {{tasks[0] && tasks[0].done ? 'done' : ''}}">
        <text wx:if="{{tasks[0] && tasks[0].done}}">å·²ç­¾åˆ°</text>
        <text wx:else>ç­¾åˆ° +{{tasks[0] && tasks[0].points || 5}}åˆ†</text>
      </view>
    </view>
  </view>

  <!-- Tab åˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{activeTab === 'tasks' ? 'active' : ''}}"
          bindtap="switchTab" data-tab="tasks">ä»»åŠ¡</view>
    <view class="tab-item {{activeTab === 'logs' ? 'active' : ''}}"
          bindtap="switchTab" data-tab="logs">æµæ°´</view>
    <view class="tab-item {{activeTab === 'levels' ? 'active' : ''}}"
          bindtap="switchTab" data-tab="levels">ç­‰çº§ç‰¹æƒ</view>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <view class="tab-content" wx:if="{{activeTab === 'tasks'}}">
    <view class="task-list">
      <view class="task-item" wx:for="{{tasks}}" wx:key="id">
        <view class="task-left">
          <view class="task-icon-wrap">
            <image class="task-icon" src="/assets/icons/gift.svg" mode="aspectFit"/>
          </view>
          <view class="task-info">
            <text class="task-title">{{item.title}}</text>
            <text class="task-desc">{{item.desc}}</text>
            <!-- å¸¦è¿›åº¦çš„ä»»åŠ¡ -->
            <view class="task-progress-bar" wx:if="{{item.total}}">
              <view class="task-progress-fill"
                    style="width: {{(item.current / item.total) * 100}}%;"/>
              <text class="task-progress-text">{{item.current}}/{{item.total}}</text>
            </view>
          </view>
        </view>
        <view class="task-reward {{item.done ? 'done' : ''}}">
          <text wx:if="{{item.done}}">å·²å®Œæˆ</text>
          <text wx:else>+{{item.points}}åˆ†</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç§¯åˆ†æµæ°´ -->
  <view class="tab-content" wx:if="{{activeTab === 'logs'}}">
    <view class="empty-tip" wx:if="{{logs.length === 0}}">
      <image src="/assets/icons/package.svg" class="empty-icon" mode="aspectFit"/>
      <text>æš‚æ— ç§¯åˆ†è®°å½•</text>
    </view>
    <view class="log-list" wx:else>
      <view class="log-item" wx:for="{{logs}}" wx:key="id">
        <view class="log-left">
          <text class="log-type">{{item.remark || item.type}}</text>
          <text class="log-time">{{item.created_at}}</text>
        </view>
        <view class="log-points {{item.points >= 0 ? 'positive' : 'negative'}}">
          {{item.points >= 0 ? '+' : ''}}{{item.points}}
        </view>
      </view>
    </view>
  </view>

  <!-- ç­‰çº§ç‰¹æƒ -->
  <view class="tab-content" wx:if="{{activeTab === 'levels'}}">
    <view class="level-card" wx:for="{{levelConfig}}" wx:key="level"
          class="level-card {{item.level <= (account && account.level || 0) ? 'unlocked' : 'locked'}}">
      <view class="level-header">
        <view class="lv-badge lv-{{item.level}}">Lv.{{item.level}}</view>
        <text class="lv-name">{{item.name}}</text>
        <text class="lv-req">{{item.min}}åˆ†èµ·</text>
        <view class="lv-status" wx:if="{{item.level <= (account && account.level || 0)}}">
          <image class="check-icon" src="/assets/icons/check-circle.svg" mode="aspectFit"/>
          <text>å·²è§£é”</text>
        </view>
      </view>
      <view class="level-perks">
        <view class="perk-item" wx:for="{{item.perks}}" wx:for-item="perk" wx:key="*this">
          <image class="perk-dot" src="/assets/icons/star.svg" mode="aspectFit"/>
          <text class="perk-text">{{perk}}</text>
        </view>
      </view>
    </view>
  </view>

  <view style="height: 60rpx;"/>
</view>
