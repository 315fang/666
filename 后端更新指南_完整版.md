# 🚀 后端服务器更新指南 - 完整版本升级

> **更新日期**: 2026年2月10日
> **从版本**: s2b2c-backend (服务器当前版本)
> **到版本**: backend (最新代码仓库版本)
> **重要程度**: ⭐⭐⭐⭐⭐ 包含安全增强、性能优化和新功能

---

## 📋 目录

- [快速概览](#快速概览)
- [版本差异总结](#版本差异总结)
- [准备工作](#准备工作)
- [详细更新步骤](#详细更新步骤)
- [配置文件更新](#配置文件更新)
- [数据库变更](#数据库变更)
- [验证测试](#验证测试)
- [回滚方案](#回滚方案)
- [常见问题](#常见问题)

---

## 快速概览

### 本次更新内容

| 类别 | 数量 | 说明 |
|------|------|------|
| 🆕 新增文件 | 10+ | 安全文档、服务层、工具类 |
| 📝 修改文件 | 20+ | 控制器、路由、配置优化 |
| ⚙️ 配置更新 | 1 | .env 环境变量增强 |
| 🗄️ 数据库变更 | 0 | 无需修改数据库结构 |
| 📦 依赖包 | 0 | 无新增依赖，无需 npm install |

### 是否需要停机？

**建议短暂停机（2-5分钟）** 进行更新，以确保更新过程平稳。

### 预计耗时

- 备份: 5分钟
- 上传文件: 10-15分钟
- 配置更新: 5-10分钟
- 重启验证: 5分钟
- **总计**: 约 30-40 分钟

---

## 版本差异总结

### 🎯 核心改进

#### 1. 安全增强 (Security Enhancements)

**新增功能**:
- ✅ JWT 密钥长度验证（强制至少32字符）
- ✅ 生产环境安全检查（启动时验证配置）
- ✅ CORS 自动配置（根据域名设置credentials）
- ✅ 请求验证中间件（统一参数验证）
- ✅ 结构化日志系统（审计追踪）
- ✅ 任务锁机制（防止重复执行）

**文档**:
- `SECURITY.md` - 完整的安全配置指南

#### 2. 代码重构 (Code Refactoring)

**新增服务层** (`services/` 目录):
- `CommissionService.js` - 佣金计算服务（18KB）
- `OrderService.js` - 订单处理服务（13KB）
- `PricingService.js` - 价格计算服务（8KB）
- `OrderNumberService.js` - 订单号生成服务（7KB）
- `CacheService.js` - 缓存服务（9KB）

**好处**:
- 业务逻辑集中管理
- 代码可复用性提高
- 更易于维护和测试

#### 3. 工具增强 (Utility Enhancements)

**新增工具类**:
- `utils/logger.js` - 结构化日志记录
- `utils/taskLock.js` - 任务锁定机制

#### 4. 验证中间件 (Validation Middleware)

**新增文件**:
- `middleware/validation.js` - 统一请求参数验证

**功能**:
- 登录参数验证
- 订单创建验证
- 地址信息验证
- 防止无效请求攻击

#### 5. 文档完善 (Documentation)

**新增文档**:
- `SECURITY.md` - 安全配置指南
- `SERVICES.md` - 服务说明文档
- `__tests__/` - 测试用例（供开发参考）

#### 6. 管理后台改进

**功能增强**:
- 佣金管理页面（`CommissionList.vue`）
- 系统管理功能（`system/` 目录）
- 订单流程优化
- 用户管理增强

---

## 准备工作

### 1. 备份当前服务器文件 ⚠️

**非常重要！** 更新前必须备份：

```bash
# 登录服务器
ssh user@your-server

# 创建备份目录
mkdir -p ~/backups
cd ~/backups

# 备份后端代码
tar -czf backend_backup_$(date +%Y%m%d_%H%M%S).tar.gz /path/to/backend/

# 备份数据库
mysqldump -u root -p s2b2c_db > s2b2c_db_backup_$(date +%Y%m%d_%H%M%S).sql

# 备份 .env 配置文件
cp /path/to/backend/.env ~/backups/.env.backup_$(date +%Y%m%d)
```

### 2. 检查服务器环境

```bash
# 检查 Node.js 版本（应该 >= 16.0）
node --version

# 检查 npm 版本
npm --version

# 检查 PM2 状态
pm2 list

# 检查磁盘空间（至少需要 100MB 剩余）
df -h

# 检查当前运行的进程
ps aux | grep node
```

### 3. 下载更新包

**方法一：从代码仓库下载**

```bash
# 在本地电脑
cd /path/to/666
cd backend
zip -r backend_update_$(date +%Y%m%d).zip . -x "node_modules/*" -x ".git/*"
```

**方法二：使用 Git（如果服务器有 Git）**

```bash
# 在服务器上
cd /path/to/backend
git fetch origin
git diff HEAD origin/main --name-only  # 查看将要更新的文件
```

---

## 详细更新步骤

### 步骤 1: 停止后端服务

```bash
# 查看当前运行的服务
pm2 list

# 停止后端服务
pm2 stop s2b2c-backend
# 或者
pm2 stop all

# 确认服务已停止
pm2 list
```

### 步骤 2: 上传新文件

#### 2.1 新增文件清单（必须上传）

| 序号 | 文件路径 | 说明 | 大小 |
|:---:|---------|------|------|
| 1 | `SECURITY.md` | 安全配置文档 | 4.4KB |
| 2 | `SERVICES.md` | 服务说明文档 | 11.4KB |
| 3 | `middleware/validation.js` | 验证中间件 | ~5KB |
| 4 | `services/CommissionService.js` | 佣金服务 | 18.9KB |
| 5 | `services/OrderService.js` | 订单服务 | 13.4KB |
| 6 | `services/PricingService.js` | 价格服务 | 8.1KB |
| 7 | `services/OrderNumberService.js` | 订单号服务 | 6.9KB |
| 8 | `services/CacheService.js` | 缓存服务 | 8.9KB |
| 9 | `utils/logger.js` | 日志工具 | ~3KB |
| 10 | `utils/taskLock.js` | 任务锁工具 | ~2KB |
| 11 | `routes/commissions.js` | 佣金路由 | ~2KB |
| 12 | `routes/admin/controllers/adminStatsController.js` | 统计控制器 | ~5KB |
| 13 | `admin-ui/src/views/finance/CommissionList.vue` | 佣金列表页 | ~8KB |
| 14 | `admin-ui/src/views/system/` | 系统管理（整个目录） | ~10KB |
| 15 | `seeds/migration_v6_product_detail_images.sql` | 数据迁移脚本 | ~1KB |
| 16 | `package.test.json` | 测试配置 | ~1KB |

#### 2.2 需要覆盖的文件清单

| 序号 | 文件路径 | 主要变更 |
|:---:|---------|----------|
| 1 | `.env.example` | 增加安全配置说明 |
| 2 | `app.js` | 增加安全检查 |
| 3 | `server.js` | 增强错误处理 |
| 4 | `config/constants.js` | 增加新常量 |
| 5 | `controllers/authController.js` | 增强验证 |
| 6 | `controllers/orderController.js` | 使用服务层 |
| 7 | `controllers/productController.js` | 优化查询 |
| 8 | `routes/auth.js` | 增加验证中间件 |
| 9 | `routes/orders.js` | 增强路由 |
| 10 | `routes/addresses.js` | 增加验证 |
| 11 | `routes/admin/index.js` | 增加新路由 |
| 12 | `routes/admin/controllers/adminProductController.js` | 功能增强 |
| 13 | `models/Product.js` | 字段优化 |
| 14 | `admin-ui/src/router/index.js` | 新增路由 |
| 15 | `admin-ui/src/views/Dashboard.vue` | UI 优化 |
| 16 | `admin-ui/src/views/Layout.vue` | 菜单更新 |
| 17 | `admin-ui/src/views/product/ProductList.vue` | 功能增强 |

#### 2.3 上传方式

**方法A：使用 FTP/SFTP 工具（推荐新手）**

1. 打开 FTP 工具（FileZilla、WinSCP 等）
2. 连接到服务器
3. 导航到 `/path/to/backend/`
4. 按照上面的文件清单逐个上传
5. 对于已存在的文件，选择"覆盖"

**方法B：使用 rsync（推荐）**

```bash
# 在本地电脑执行
# 备份并同步（会跳过 node_modules）
rsync -avz --exclude 'node_modules' \
           --exclude '.git' \
           --exclude '.env' \
           ./backend/ user@your-server:/path/to/backend/
```

**方法C：使用 scp**

```bash
# 上传单个文件
scp /local/path/file.js user@server:/remote/path/

# 上传整个目录
scp -r /local/path/services user@server:/remote/path/backend/
```

### 步骤 3: 创建新目录（如果不存在）

```bash
# SSH 登录服务器
ssh user@your-server

# 进入后端目录
cd /path/to/backend

# 创建必要的目录
mkdir -p services
mkdir -p admin-ui/src/views/finance
mkdir -p admin-ui/src/views/system
```

### 步骤 4: 上传管理后台前端

**如果修改了 admin-ui，需要重新构建：**

```bash
# 在本地电脑，进入 admin-ui 目录
cd backend/admin-ui

# 安装依赖（如果还没有）
npm install

# 构建生产版本
npm run build

# 上传 dist 目录到服务器
rsync -avz --delete dist/ user@your-server:/path/to/backend/admin-ui/dist/
```

**或者直接上传已构建好的 dist 目录：**

```bash
# 删除服务器上的旧 dist
ssh user@your-server "rm -rf /path/to/backend/admin-ui/dist"

# 上传新的 dist
scp -r backend/admin-ui/dist user@your-server:/path/to/backend/admin-ui/
```

---

## 配置文件更新

### 更新 .env 文件 ⚠️

**重要！** 需要手动更新服务器上的 `.env` 文件。

#### 1. 备份现有配置

```bash
cp /path/to/backend/.env /path/to/backend/.env.backup
```

#### 2. 检查并更新配置项

打开 `.env` 文件：

```bash
vi /path/to/backend/.env
# 或使用其他编辑器
nano /path/to/backend/.env
```

#### 3. 必须添加/修改的配置项

```ini
# ========== JWT 配置（安全增强） ==========
# ⚠️ 密钥长度必须至少32字符，否则生产环境启动失败！
JWT_SECRET=your_super_secret_key_at_least_32_chars_long_change_this_in_production
JWT_EXPIRES_IN=7d
ADMIN_JWT_SECRET=your_admin_secret_key_at_least_32_chars_change_this_in_production
ADMIN_JWT_EXPIRES_IN=24h

# ========== CORS 配置（安全增强） ==========
# 开发环境可以用 * (不启用credentials)
# 生产环境必须配置具体域名列表（启用credentials）
# 多个域名用逗号分隔，例如：https://example.com,https://admin.example.com
# 注意：配置具体域名后会自动启用 credentials: true
CORS_ORIGINS=https://api.jxalk.cn,https://admin.jxalk.cn

# ========== 调试开关（生产环境务必关闭！） ==========
# 默认关闭，需要显式启用
# ⚠️ 生产环境不要设置为 true
ENABLE_DEBUG_ROUTES=false
ENABLE_TEST_ROUTES=false
ALLOW_OPENID_AUTH=false
```

#### 4. 验证配置

确保你的 `.env` 包含所有必要配置：

```bash
# 检查 JWT 密钥长度
echo $JWT_SECRET | wc -c
# 应该输出 >= 33（32个字符 + 换行符）

# 检查配置完整性
cat .env | grep -E "JWT_SECRET|CORS_ORIGINS|ENABLE_DEBUG"
```

---

## 数据库变更

### 好消息！本次更新无需修改数据库结构 ✅

**原因**：
- 所有新功能使用现有数据表
- 服务层重构不影响数据模型
- 中间件和工具类纯代码改动

**可选操作**（如果需要）：

```sql
-- 检查数据库是否正常
USE s2b2c_db;
SHOW TABLES;

-- 验证关键表存在
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM orders;
SELECT COUNT(*) FROM products;
```

---

## 验证测试

### 步骤 1: 重启后端服务

```bash
# 使用 PM2 重启
pm2 restart s2b2c-backend
# 或
pm2 restart all

# 查看启动日志
pm2 logs s2b2c-backend --lines 50

# 确认无错误信息
pm2 list
```

### 步骤 2: 健康检查

```bash
# 测试健康检查端点
curl https://api.jxalk.cn/health

# 预期输出：
# {"status":"ok","message":"Server is running","timestamp":"..."}
```

### 步骤 3: 测试关键 API

```bash
# 测试商品列表
curl https://api.jxalk.cn/api/products | jq

# 测试分类列表
curl https://api.jxalk.cn/api/categories | jq

# 预期：返回 JSON 数据，无错误
```

### 步骤 4: 管理后台验证

1. **登录测试**
   ```
   访问: https://api.jxalk.cn/admin/
   使用管理员账号登录
   ```

2. **功能检查**
   - [ ] 首页仪表盘数据显示正常
   - [ ] 商品管理：列表、添加、编辑功能正常
   - [ ] 订单管理：订单列表、详情、发货功能正常
   - [ ] 用户管理：用户列表、等级修改功能正常
   - [ ] 财务管理：提现审核、佣金记录（新功能）
   - [ ] 系统管理：菜单显示正常（如有新增）

3. **新功能验证**
   - 访问"财务管理" → "佣金管理"（新增页面）
   - 应该能看到佣金记录列表

### 步骤 5: 小程序测试

1. **登录测试**
   - 打开小程序
   - 微信登录应该正常
   - 无 400 错误

2. **核心功能**
   - [ ] 商品浏览正常
   - [ ] 添加购物车正常
   - [ ] 下单流程正常
   - [ ] 订单列表正常
   - [ ] 分销中心正常

### 步骤 6: 查看日志

```bash
# 实时查看日志
pm2 logs s2b2c-backend --lines 100

# 检查是否有错误
pm2 logs s2b2c-backend --err --lines 50

# 查看启动信息
cat /path/to/backend/logs/app.log | tail -100
```

---

## 回滚方案

### 如果更新后出现问题，按以下步骤回滚：

#### 方法一：使用备份恢复（推荐）

```bash
# 1. 停止服务
pm2 stop all

# 2. 恢复代码
cd /path/to
rm -rf backend
tar -xzf ~/backups/backend_backup_YYYYMMDD_HHMMSS.tar.gz

# 3. 恢复 .env
cp ~/backups/.env.backup_YYYYMMDD backend/.env

# 4. 恢复数据库（如果有改动）
mysql -u root -p s2b2c_db < ~/backups/s2b2c_db_backup_YYYYMMDD_HHMMSS.sql

# 5. 重启服务
pm2 restart all
```

#### 方法二：使用 Git 回滚（如果使用 Git）

```bash
# 1. 停止服务
pm2 stop all

# 2. 回滚代码
cd /path/to/backend
git reset --hard HEAD~1  # 回退到上一个版本
# 或
git checkout <commit-hash>  # 回退到特定版本

# 3. 重启服务
pm2 restart all
```

---

## 常见问题

### Q1: 启动时报错 "JWT_SECRET must be at least 32 characters"

**原因**: JWT 密钥长度不足

**解决**:
```bash
# 编辑 .env 文件
vi /path/to/backend/.env

# 修改 JWT_SECRET 和 ADMIN_JWT_SECRET
# 确保每个至少32个字符
JWT_SECRET=abcdefghijklmnopqrstuvwxyz123456  # 至少32个字符
ADMIN_JWT_SECRET=zyxwvutsrqponmlkjihgfedcba654321

# 保存后重启
pm2 restart all
```

### Q2: 启动时警告 "Using default JWT secret in production"

**原因**: 使用了示例配置中的默认密钥

**解决**:
```bash
# 生成随机密钥
openssl rand -base64 48

# 将生成的密钥写入 .env
JWT_SECRET=生成的随机密钥
ADMIN_JWT_SECRET=另一个随机密钥
```

### Q3: 小程序登录报 400 错误

**原因**:
1. WECHAT_APPID 或 WECHAT_SECRET 配置错误
2. 微信公众平台未配置合法域名

**解决**:
```bash
# 1. 检查 .env 配置
cat /path/to/backend/.env | grep WECHAT

# 2. 确认值正确
WECHAT_APPID=wx1b40a6e80f4326ab
WECHAT_SECRET=你的真实AppSecret

# 3. 检查微信公众平台配置
# 登录 https://mp.weixin.qq.com/
# 开发管理 → 开发设置 → 服务器域名
# 确保添加了 https://api.jxalk.cn
```

### Q4: 管理后台看不到新增的菜单

**原因**: admin-ui 没有更新或浏览器缓存

**解决**:
```bash
# 1. 确认 dist 已更新
ls -lh /path/to/backend/admin-ui/dist/

# 2. 清除浏览器缓存
# Chrome: Ctrl+Shift+Delete → 清除缓存和Cookie

# 3. 强制刷新页面
# Chrome: Ctrl+Shift+R (Windows) 或 Cmd+Shift+R (Mac)
```

### Q5: 上传文件时权限错误

**原因**: 文件权限不正确

**解决**:
```bash
# 修改文件所有者
chown -R www-data:www-data /path/to/backend/

# 或者
chown -R node:node /path/to/backend/

# 修改文件权限
chmod -R 755 /path/to/backend/
```

### Q6: PM2 启动失败

**原因**: 端口被占用或配置错误

**解决**:
```bash
# 1. 检查端口占用
netstat -tulpn | grep 3000
# 或
lsof -i :3000

# 2. 杀掉占用进程
kill -9 <PID>

# 3. 检查 PM2 配置
pm2 describe s2b2c-backend

# 4. 删除并重新启动
pm2 delete s2b2c-backend
pm2 start server.js --name s2b2c-backend
```

### Q7: 数据库连接失败

**原因**: .env 中数据库配置错误

**解决**:
```bash
# 1. 测试数据库连接
mysql -h localhost -u root -p -e "SELECT 1;"

# 2. 检查 .env 配置
cat /path/to/backend/.env | grep DB_

# 3. 确认配置正确
DB_HOST=localhost
DB_PORT=3306
DB_NAME=s2b2c_db
DB_USER=root
DB_PASSWORD=你的数据库密码
```

---

## 📋 更新检查清单

### 更新前

- [ ] 已备份服务器代码
- [ ] 已备份数据库
- [ ] 已备份 .env 配置文件
- [ ] 已检查服务器磁盘空间
- [ ] 已通知用户系统维护

### 更新中

- [ ] 已停止后端服务
- [ ] 已上传所有新增文件（10+ 个）
- [ ] 已覆盖所有修改文件（20+ 个）
- [ ] 已更新 .env 配置文件
- [ ] 已上传新的 admin-ui/dist（如有修改）
- [ ] 已创建必要的目录

### 更新后

- [ ] 后端服务启动成功
- [ ] 健康检查端点正常
- [ ] 管理后台登录正常
- [ ] 管理后台功能正常
- [ ] 小程序登录正常
- [ ] 小程序核心功能正常
- [ ] 无错误日志
- [ ] 新功能（佣金管理）可访问

---

## 📞 技术支持

### 获取帮助

如果更新过程中遇到问题：

1. **查看日志**
   ```bash
   pm2 logs s2b2c-backend --lines 100
   ```

2. **检查文档**
   - `SECURITY.md` - 安全配置
   - `SERVICES.md` - 服务说明
   - `新手入门指南.md` - 基础配置
   - `快速故障排查清单.md` - 故障排查

3. **问题反馈**
   - GitHub Issues: https://github.com/315fang/666/issues
   - 提供完整的错误日志
   - 说明操作步骤

### 紧急联系

如果出现严重问题需要紧急回滚：
1. 立即执行回滚方案（见上文）
2. 记录错误信息和操作日志
3. 联系技术支持

---

## 📝 附录

### A. 文件对照表

**本地代码位置 → 服务器位置**

```
本地: backend/services/CommissionService.js
→ 服务器: /path/to/backend/services/CommissionService.js

本地: backend/middleware/validation.js
→ 服务器: /path/to/backend/middleware/validation.js

本地: backend/utils/logger.js
→ 服务器: /path/to/backend/utils/logger.js

...（其他文件类似）
```

### B. 命令速查

```bash
# 备份
tar -czf backup.tar.gz /path/to/backend/

# 上传
scp file.js user@server:/path/

# 重启服务
pm2 restart all

# 查看日志
pm2 logs --lines 50

# 检查状态
pm2 list

# 数据库备份
mysqldump -u root -p dbname > backup.sql

# 数据库恢复
mysql -u root -p dbname < backup.sql
```

### C. 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| v2.0 | 2026-02-10 | 安全增强、服务层重构、新增工具类 |
| v1.5 | 2026-02-08 | 分佣系统完善、订单流程优化 |
| v1.0 | 2025-12-01 | 初始版本 |

---

**更新完成后，请仔细阅读新增的 `SECURITY.md` 文档，了解安全配置最佳实践！** 🔒

**祝更新顺利！** 🎉
