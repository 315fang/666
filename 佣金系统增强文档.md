# ä½£é‡‘ç³»ç»Ÿå¢å¼ºåŠŸèƒ½æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†å¢å¼ºåçš„ä½£é‡‘ç³»ç»Ÿï¼Œæ”¯æŒå›ºå®šé‡‘é¢å’Œç™¾åˆ†æ¯”ä¸¤ç§è®¡ç®—æ¨¡å¼ï¼Œå¹¶æä¾›äº†å®Œæ•´çš„ç”¨æˆ·ç«¯å’Œç®¡ç†ç«¯åŠŸèƒ½ã€‚

---

## ä¸€ã€æ ¸å¿ƒæœåŠ¡

### 1. CommissionService (ä½£é‡‘è®¡ç®—æœåŠ¡)

**ä½ç½®**: `backend/services/CommissionService.js`

#### ä¸»è¦åŠŸèƒ½

##### 1.1 è®¡ç®—è®¢å•ä½£é‡‘

```javascript
const result = await CommissionService.calculateOrderCommissions({
    order: orderObject,
    buyer: buyerObject,
    parent: parentObject,         // å¯é€‰
    grandparent: grandparentObject, // å¯é€‰
    agent: agentObject,           // å¯é€‰
    mode: 'auto' | 'fixed' | 'percentage',
    customRates: null             // å¯é€‰ï¼Œè‡ªå®šä¹‰ä½£é‡‘é…ç½®
});

// è¿”å›ç»“æœ
{
    commissions: [
        { user_id, amount, type, level, description },
        ...
    ],
    totalCommission: æ€»ä½£é‡‘é‡‘é¢,
    agentProfit: ä»£ç†å•†åˆ©æ¶¦,
    profitPool: åˆ©æ¶¦æ± ,
    calculationMode: ä½¿ç”¨çš„è®¡ç®—æ¨¡å¼,
    breakdown: {
        actualPrice: å®é™…å”®ä»·,
        wholesalePrice: æ‰¹å‘ä»·,
        profitPool: åˆ©æ¶¦æ± ,
        totalCommission: æ€»ä½£é‡‘,
        agentProfit: ä»£ç†å•†åˆ©æ¶¦
    }
}
```

**æ ¸å¿ƒå…¬å¼**ï¼š
```
åˆ©æ¶¦æ±  = å®é™…å”®ä»· - æ‰¹å‘ä»·
ä»£ç†å•†åˆ©æ¶¦ = åˆ©æ¶¦æ±  - æ‰€æœ‰å‚ä¸è€…ä½£é‡‘æ€»å’Œ
```

##### 1.2 ä½£é‡‘è®¡ç®—æ¨¡å¼

**å›ºå®šé‡‘é¢æ¨¡å¼** (é»˜è®¤):
```javascript
DEFAULT_CONFIG.FIXED_AMOUNTS = {
    MEMBER_DIRECT: 60,      // ä¼šå‘˜ç›´æ¨ Â¥60
    LEADER_DIRECT: 90,      // å›¢é•¿ç›´æ¨ Â¥90
    AGENT_DIRECT: 120,      // ä»£ç†å•†ç›´æ¨ Â¥120
    LEADER_TEAM: 30,        // å›¢é•¿å›¢é˜Ÿä½£é‡‘ Â¥30
    AGENT_TEAM: 50          // ä»£ç†å•†å›¢é˜Ÿä½£é‡‘ Â¥50
}
```

**ç™¾åˆ†æ¯”æ¨¡å¼**:
```javascript
DEFAULT_CONFIG.PERCENTAGE_RATES = {
    DIRECT: {
        1: 0.05,   // ä¼šå‘˜ 5%
        2: 0.08,   // å›¢é•¿ 8%
        3: 0.12    // ä»£ç†å•† 12%
    },
    INDIRECT: {
        2: 0.03,   // å›¢é•¿é—´æ¥ 3%
        3: 0.05    // ä»£ç†å•†é—´æ¥ 5%
    },
    SELF: {
        1: 0.03,   // ä¼šå‘˜è‡ªè´­è¿”åˆ© 3%
        2: 0.05,   // å›¢é•¿è‡ªè´­è¿”åˆ© 5%
        3: 0.08    // ä»£ç†å•†è‡ªè´­è¿”åˆ© 8%
    }
}
```

##### 1.3 ä½£é‡‘é¢„è§ˆ

```javascript
const preview = await CommissionService.previewCommission({
    productId: å•†å“ID,
    skuId: SKU ID (å¯é€‰),
    quantity: æ•°é‡,
    userId: ç”¨æˆ·ID,
    mode: 'auto'
});

// è¿”å›
{
    success: true,
    data: {
        product: { id, name },
        pricing: {
            actualPrice: å®é™…å”®ä»·,
            wholesalePrice: æ‰¹å‘ä»·,
            profitPool: åˆ©æ¶¦æ± ,
            quantity: æ•°é‡
        },
        commissions: [
            { user_id, amount, type, level, description },
            ...
        ],
        totalCommission: æ€»ä½£é‡‘,
        agentProfit: ä»£ç†å•†åˆ©æ¶¦,
        calculationMode: è®¡ç®—æ¨¡å¼,
        userRole: ç”¨æˆ·è§’è‰²,
        hasParent: æ˜¯å¦æœ‰ä¸Šçº§,
        hasGrandparent: æ˜¯å¦æœ‰ä¸Šä¸Šçº§
    }
}
```

##### 1.4 åˆ›å»ºä½£é‡‘è®°å½•

```javascript
const records = await CommissionService.createCommissionRecords({
    orderId: è®¢å•ID,
    orderNo: è®¢å•å·,
    commissions: ä½£é‡‘æ•°ç»„,
    refundDeadline: é€€æ¬¾æˆªæ­¢æ—¥æœŸ,
    transaction: sequelizeäº‹åŠ¡å¯¹è±¡
});
```

##### 1.5 ç”¨æˆ·ä½£é‡‘ç»Ÿè®¡

```javascript
const stats = await CommissionService.getUserCommissionStats(userId);

// è¿”å›
{
    frozen: { count, total },              // å†»ç»“ä¸­
    pending_approval: { count, total },    // å¾…å®¡æ‰¹
    approved: { count, total },            // å·²å®¡æ‰¹
    settled: { count, total },             // å·²ç»“ç®—
    cancelled: { count, total },           // å·²å–æ¶ˆ
    total: { count, total }                // æ€»è®¡ï¼ˆä¸å«cancelledï¼‰
}
```

---

### 2. OrderService (è®¢å•æœåŠ¡)

**ä½ç½®**: `backend/services/OrderService.js`

#### ä¸»è¦åŠŸèƒ½

##### 2.1 åˆ›å»ºè®¢å•

```javascript
const result = await OrderService.createOrder({
    userId: ç”¨æˆ·ID,
    items: [
        { product_id, sku_id, quantity },
        ...
    ],
    addressId: åœ°å€ID,
    remark: å¤‡æ³¨,
    distributorId: åˆ†é”€å•†ID (å¯é€‰)
});
```

##### 2.2 æ”¯ä»˜è®¢å•

```javascript
const result = await OrderService.payOrder(orderId, paymentMethod);
```

- è‡ªåŠ¨å‡çº§æ™®é€šç”¨æˆ·ä¸ºä¼šå‘˜
- æ›´æ–°ç”¨æˆ·æ€»é”€å”®é¢

##### 2.3 å‘è´§å¹¶ç”Ÿæˆä½£é‡‘

```javascript
const result = await OrderService.shipOrder(orderId, {
    tracking_no: ç‰©æµå•å·,
    shipping_company: ç‰©æµå…¬å¸
});
```

- æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²å‘è´§
- è®¡ç®—å¹¶åˆ›å»ºä½£é‡‘è®°å½•
- è®¾ç½®é€€æ¬¾æˆªæ­¢æ—¥æœŸ

##### 2.4 ç¡®è®¤æ”¶è´§

```javascript
const result = await OrderService.confirmOrder(orderId);
```

---

## äºŒã€API æ¥å£

### ç”¨æˆ·ç«¯æ¥å£

#### 1. ä½£é‡‘é¢„è§ˆ
```
GET /api/commissions/preview?product_id=1&sku_id=1&quantity=1
Authorization: Bearer {token}

Response:
{
    code: 0,
    data: {
        product: { id, name },
        pricing: { ... },
        commissions: [ ... ],
        totalCommission: 100.00,
        agentProfit: 50.00
    }
}
```

#### 2. æˆ‘çš„ä½£é‡‘ç»Ÿè®¡
```
GET /api/commissions/my-stats
Authorization: Bearer {token}

Response:
{
    code: 0,
    data: {
        frozen: { count: 5, total: 300.00 },
        pending_approval: { count: 2, total: 120.00 },
        approved: { count: 3, total: 180.00 },
        settled: { count: 10, total: 600.00 },
        total: { count: 20, total: 1200.00 }
    }
}
```

#### 3. ä½£é‡‘é…ç½®
```
GET /api/commissions/config
Authorization: Bearer {token}

Response:
{
    code: 0,
    data: {
        USER_ROLES: { ... },
        COMMISSION_TYPES: { ... },
        DEFAULT_CONFIG: { ... }
    }
}
```

### ç®¡ç†ç«¯æ¥å£

#### 1. ç»Ÿè®¡æ¦‚è§ˆ
```
GET /admin/api/statistics/overview?period=today|week|month|year

Response:
{
    code: 0,
    data: {
        period: 'today',
        sales: {
            currentSales: 10000.00,
            previousSales: 8000.00,
            growthRate: 25.00,
            totalCommissions: 2000.00,
            platformProfit: 8000.00,
            profitMargin: 80.00
        },
        users: {
            newUsers: 50,
            activeUsers: 200,
            totalUsers: 1000,
            roleDistribution: { guest: 500, member: 300, leader: 150, agent: 50 }
        },
        commissions: {
            periodStats: { ... },
            pendingApprovalCount: 15
        },
        orders: {
            statusDistribution: { ... },
            avgOrderAmount: 150.00
        },
        products: {
            lowStockCount: 5,
            topProducts: [ ... ]
        },
        trends: {
            sales: [ ... ]
        }
    }
}
```

#### 2. ä»£ç†å•†æ’è¡Œæ¦œ
```
GET /admin/api/statistics/agent-ranking?period=month&limit=20

Response:
{
    code: 0,
    data: {
        period: 'month',
        ranking: [
            {
                rank: 1,
                userId: 123,
                nickname: 'å¼ ä¸‰',
                avatarUrl: '...',
                roleLevel: 3,
                orderCount: 50,
                totalSales: 15000.00,
                teamSize: 20,
                totalCommission: 3000.00
            },
            ...
        ]
    }
}
```

---

## ä¸‰ã€å‰ç«¯é›†æˆ

### å•†å“è¯¦æƒ…é¡µä½£é‡‘é¢„è§ˆ

**æ–‡ä»¶**: `qianduan/pages/product/detail.js`

#### åŠŸèƒ½
- è‡ªåŠ¨ä¸ºå›¢é•¿å’Œä»£ç†å•†åŠ è½½ä½£é‡‘é¢„è§ˆ
- æ˜¾ç¤ºé¢„ä¼°æ”¶ç›Š
- æ”¯æŒSKUå’Œæ•°é‡å˜åŒ–æ—¶å®æ—¶æ›´æ–°

#### å®ç°
```javascript
// åŠ è½½ä½£é‡‘é¢„è§ˆ
async loadCommissionPreview() {
    const { id, selectedSku, quantity } = this.data;
    const params = {
        product_id: id,
        quantity: quantity || 1
    };

    if (selectedSku) {
        params.sku_id = selectedSku.id;
    }

    const res = await get('/commissions/preview', params);

    if (res.code === 0 && res.data) {
        const myCommission = res.data.commissions
            .filter(c => c.level === 0 || c.level === 1)
            .reduce((sum, c) => sum + c.amount, 0);

        this.setData({
            commission: myCommission.toFixed(2),
            commissionDetail: res.data,
            showCommissionTip: true
        });
    }
}
```

#### UIæ˜¾ç¤º
```wxml
<view class="agent-box" wx:if="{{isAgent && commission > 0}}">
    <view class="agent-tag">
        <text class="agent-icon">ğŸ“ˆ</text>
        <text class="agent-text">ä»£ç†å•†ç‰¹æƒï¼šåˆ†äº«èµš Â¥{{commission}}</text>
    </view>
    <text class="agent-arrow">â€º</text>
</view>
```

---

## å››ã€ä½£é‡‘åˆ†é…ç¤ºä¾‹

### åœºæ™¯ 1: ä¼šå‘˜è‡ªè´­
- å•†å“é›¶å”®ä»·: Â¥200
- æ‰¹å‘ä»·: Â¥100
- åˆ©æ¶¦æ± : Â¥100

**å›ºå®šé‡‘é¢æ¨¡å¼**:
```
ä¼šå‘˜è‡ªè´­ä½£é‡‘: Â¥60
ä¼šå‘˜ä¸Šçº§(å›¢é•¿)å›¢é˜Ÿä½£é‡‘: Â¥30
ä»£ç†å•†åˆ©æ¶¦: Â¥10 (å‰©ä½™åˆ©æ¶¦)
```

**ç™¾åˆ†æ¯”æ¨¡å¼**:
```
ä¼šå‘˜è‡ªè´­è¿”åˆ©: Â¥200 Ã— 3% = Â¥6
ä¼šå‘˜ä¸Šçº§(å›¢é•¿)ç›´æ¨ä½£é‡‘: Â¥200 Ã— 8% = Â¥16
å›¢é•¿ä¸Šçº§(ä»£ç†å•†)é—´æ¥ä½£é‡‘: Â¥200 Ã— 5% = Â¥10
æ€»ä½£é‡‘: Â¥32
ä»£ç†å•†åˆ©æ¶¦: Â¥100 - Â¥32 = Â¥68
```

### åœºæ™¯ 2: å›¢é•¿ç›´æ¨
- å•†å“é›¶å”®ä»·: Â¥200
- æ‰¹å‘ä»·: Â¥100
- åˆ©æ¶¦æ± : Â¥100

**å›ºå®šé‡‘é¢æ¨¡å¼**:
```
å›¢é•¿ç›´æ¨ä½£é‡‘: Â¥90
å›¢é•¿ä¸Šçº§(ä»£ç†å•†)å›¢é˜Ÿä½£é‡‘: Â¥50 (å¦‚æœè®¾ç½®)
æˆ–
ä»£ç†å•†åˆ©æ¶¦: Â¥10 (å¦‚æœæ²¡æœ‰é¢å¤–å›¢é˜Ÿä½£é‡‘)
```

### åœºæ™¯ 3: ä»£ç†å•†è‡ªé”€
- å•†å“é›¶å”®ä»·: Â¥200
- æ‰¹å‘ä»·: Â¥100
- åˆ©æ¶¦æ± : Â¥100

**å›ºå®šé‡‘é¢æ¨¡å¼**:
```
ä»£ç†å•†ç›´æ¨ä½£é‡‘: Â¥120 (æˆ–æ›´å°‘ï¼Œå–å†³äºåˆ©æ¶¦æ± )
å‰©ä½™åˆ©æ¶¦: å½’ä»£ç†å•†
```

**ä»£ç†å•†è·å¾—**: Â¥100 (å…¨éƒ¨åˆ©æ¶¦æ± ï¼Œå› ä¸ºæ˜¯å‘è´§æ–¹)

---

## äº”ã€ç®¡ç†åå°å¢å¼º

### 1. ç»Ÿè®¡çœ‹æ¿
- å®æ—¶é”€å”®æ•°æ®
- ä½£é‡‘åˆ†å¸ƒç»Ÿè®¡
- ç”¨æˆ·å¢é•¿è¶‹åŠ¿
- å•†å“é”€å”®æ’è¡Œ
- ä»£ç†å•†ä¸šç»©æ’è¡Œ

### 2. ä½£é‡‘å®¡æ‰¹
- æ‰¹é‡å®¡æ‰¹åŠŸèƒ½
- å¾…å®¡æ‰¹é˜Ÿåˆ—
- å®¡æ‰¹å†å²è®°å½•
- æ‹’ç»åŸå› å¤‡æ³¨

### 3. æ•°æ®åˆ†æ
- é”€å”®è¶‹åŠ¿å›¾è¡¨
- ç”¨æˆ·è§’è‰²åˆ†å¸ƒ
- ä½£é‡‘çŠ¶æ€åˆ†å¸ƒ
- å¹³å°åˆ©æ¶¦åˆ†æ

---

## å…­ã€é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡
æ— éœ€é¢å¤–ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨å†…ç½®é…ç½®ã€‚

### è‡ªå®šä¹‰é…ç½®
å¯åœ¨ `CommissionService` ä¸­ä¿®æ”¹ `DEFAULT_CONFIG` æ¥è‡ªå®šä¹‰ä½£é‡‘è§„åˆ™ï¼š

```javascript
const CUSTOM_CONFIG = {
    FIXED_AMOUNTS: {
        MEMBER_DIRECT: 50,    // ä¿®æ”¹ä¼šå‘˜ä½£é‡‘
        LEADER_DIRECT: 80,
        AGENT_DIRECT: 100,
        LEADER_TEAM: 25,
        AGENT_TEAM: 40
    }
};

// ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
const result = await CommissionService.calculateOrderCommissions({
    order,
    buyer,
    parent,
    grandparent,
    mode: 'fixed',
    customRates: CUSTOM_CONFIG
});
```

---

## ä¸ƒã€æœ€ä½³å®è·µ

### 1. é€‰æ‹©è®¡ç®—æ¨¡å¼
- **å›ºå®šé‡‘é¢**: é€‚åˆåˆ©æ¶¦ç¨³å®šçš„å•†å“ï¼Œåˆ†é”€å•†æ”¶ç›Šå¯é¢„æµ‹
- **ç™¾åˆ†æ¯”**: é€‚åˆä»·æ ¼æµ®åŠ¨çš„å•†å“ï¼Œä¿è¯å¹³å°åˆ©æ¶¦ç‡
- **è‡ªåŠ¨æ¨¡å¼**: æ ¹æ®å•†å“æˆ–åˆ†ç±»é…ç½®è‡ªåŠ¨é€‰æ‹©

### 2. åˆ©æ¶¦æ± ä¿æŠ¤
ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯ï¼š
```javascript
if (totalCommission > profitPool) {
    console.warn('æ€»ä½£é‡‘è¶…è¿‡åˆ©æ¶¦æ± ');
}
```

å»ºè®®è®¾ç½®åˆç†çš„ä½£é‡‘æ¯”ä¾‹ï¼Œç¡®ä¿å¹³å°æœ‰åˆ©æ¶¦ã€‚

### 3. é€æ˜åŒ–
- å‘ç”¨æˆ·æ˜¾ç¤ºé¢„ä¼°æ”¶ç›Š
- æä¾›è¯¦ç»†çš„ä½£é‡‘æ˜ç»†
- è§£é‡Šä½£é‡‘è®¡ç®—è§„åˆ™

### 4. å®¡æ‰¹æµç¨‹
- å®šæœŸå®¡æ‰¹ä½£é‡‘ï¼ˆå»ºè®®æ¯å‘¨ï¼‰
- ä½¿ç”¨æ‰¹é‡æ“ä½œæé«˜æ•ˆç‡
- ä¿ç•™å®¡æ‰¹è®°å½•ä¾¿äºå®¡è®¡

---

## å…«ã€æ•…éšœæ’æŸ¥

### 1. ä½£é‡‘æœªç”Ÿæˆ
**æ£€æŸ¥**:
- è®¢å•æ˜¯å¦å·²å‘è´§
- CommissionServiceæ˜¯å¦è¢«æ­£ç¡®è°ƒç”¨
- æ•°æ®åº“commission_logsè¡¨æ˜¯å¦æœ‰è®°å½•

### 2. ä½£é‡‘é‡‘é¢ä¸æ­£ç¡®
**æ£€æŸ¥**:
- åˆ©æ¶¦æ± è®¡ç®—æ˜¯å¦æ­£ç¡®ï¼ˆactual_price - locked_agent_costï¼‰
- ç”¨æˆ·è§’è‰²ç­‰çº§æ˜¯å¦æ­£ç¡®
- ä¸Šçº§å…³ç³»æ˜¯å¦æ­£ç¡®

### 3. é¢„è§ˆæ¥å£å¤±è´¥
**æ£€æŸ¥**:
- ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
- ç”¨æˆ·è§’è‰²æ˜¯å¦ >= LEADER (å›¢é•¿)
- å•†å“å’ŒSKUæ˜¯å¦å­˜åœ¨

---

## ä¹ã€å‡çº§æŒ‡å—

### ä»æ—§ç³»ç»Ÿè¿ç§»

#### 1. æ•°æ®åº“
æ— éœ€ä¿®æ”¹ï¼Œä½¿ç”¨ç°æœ‰çš„ `commission_logs` è¡¨ã€‚

#### 2. æ›¿æ¢æ—§ä»£ç 
å°†åŸæœ‰çš„ä½£é‡‘è®¡ç®—é€»è¾‘æ›¿æ¢ä¸ºï¼š
```javascript
// æ—§ä»£ç 
const { calculateCommission } = require('../utils/commission');
const result = calculateCommission(buyer, order);

// æ–°ä»£ç 
const CommissionService = require('../services/CommissionService');
const result = await CommissionService.calculateOrderCommissions({
    order,
    buyer,
    parent,
    grandparent,
    mode: 'auto'
});
```

#### 3. æ›´æ–°æ§åˆ¶å™¨
ä½¿ç”¨ `OrderService` æ›¿ä»£ç›´æ¥æ“ä½œ Order æ¨¡å‹ã€‚

---

## åã€æœªæ¥æ‰©å±•

### è®¡åˆ’åŠŸèƒ½
1. **åŠ¨æ€ä½£é‡‘é…ç½®**: ä»æ•°æ®åº“è¯»å–ä½£é‡‘è§„åˆ™
2. **å•†å“çº§ä½£é‡‘**: ä¸åŒå•†å“ä¸åŒä½£é‡‘ç‡
3. **åˆ†ç±»çº§ä½£é‡‘**: ä¸åŒåˆ†ç±»ä¸åŒä½£é‡‘ç‡
4. **æ—¶æ®µä½£é‡‘**: ä¿ƒé”€æœŸé—´æé«˜ä½£é‡‘
5. **é˜¶æ¢¯ä½£é‡‘**: æ ¹æ®é”€å”®é¢ç­‰çº§è®¾ç½®ä¸åŒä½£é‡‘
6. **ä½£é‡‘é¢„ç®—**: è®¾ç½®æ¯æœˆä½£é‡‘æ€»é¢„ç®—
7. **ä½£é‡‘æŠ¥è¡¨**: å¯¼å‡ºè¯¦ç»†ä½£é‡‘æŠ¥è¡¨

---

## æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- `backend/SERVICES.md` - æœåŠ¡å±‚å®Œæ•´æ–‡æ¡£
- `ä»£ç é‡æ„è¿›åº¦æŠ¥å‘Š.md` - é‡æ„è¿›åº¦å’Œæˆæœ
- æäº¤ Issue æˆ–è”ç³»å¼€å‘å›¢é˜Ÿ
