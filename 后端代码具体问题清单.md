# åç«¯ä»£ç å…·ä½“é—®é¢˜æ¸…å•ä¸æ”¹è¿›æ–¹æ¡ˆ

æœ¬æ–‡æ¡£åˆ—å‡ºäº†åç«¯ä»£ç ä¸­å…·ä½“çš„é—®é¢˜ä½ç½®å’Œè¯¦ç»†çš„æ”¹è¿›å»ºè®®ï¼Œä¾¿äºå¼€å‘è€…é€ä¸ªä¿®å¤ã€‚

---

## 1. æ¶æ„é—®é¢˜

### é—®é¢˜ 1.1ï¼šController è¿‡äºè‡ƒè‚¿ï¼Œç¼ºå°‘ Service å±‚
**ä½ç½®ï¼š** `controllers/orderController.js:28-200`

**é—®é¢˜ï¼š**
`createOrder` å‡½æ•°åŒ…å« 200+ è¡Œä»£ç ï¼Œæ··æ‚äº†å¤šç§èŒè´£ï¼š
- å‚æ•°æ ¡éªŒ
- åº“å­˜æ£€æŸ¥å’Œé”å®š
- ä»·æ ¼è®¡ç®—
- æ‹†å•é€»è¾‘
- ä½£é‡‘è®¡ç®—
- æ•°æ®åº“æ“ä½œ
- é€šçŸ¥å‘é€

è¿™è¿åäº†å•ä¸€èŒè´£åŸåˆ™ï¼Œå¯¼è‡´ï¼š
- ä»£ç éš¾ä»¥æµ‹è¯•
- éš¾ä»¥å¤ç”¨
- ç»´æŠ¤å›°éš¾

**å»ºè®®æ”¹è¿›ï¼š**

åˆ›å»º Service å±‚ï¼š

```javascript
// services/orderService.js
const { sequelize } = require('../config/database');
const { Order, Product, SKU, User } = require('../models');
const PricingService = require('./pricingService');
const CommissionService = require('./commissionService');

class OrderService {
    /**
     * åˆ›å»ºè®¢å•
     */
    async createOrder(userId, orderData) {
        return await sequelize.transaction(async (transaction) => {
            // 1. éªŒè¯è®¢å•æ•°æ®
            const validatedData = await this.validateOrderData(orderData, userId, transaction);

            // 2. è®¡ç®—ä»·æ ¼
            const pricing = await PricingService.calculateOrderPricing(
                validatedData.product,
                validatedData.sku,
                validatedData.user,
                validatedData.quantity
            );

            // 3. æ£€æŸ¥å¹¶é”å®šåº“å­˜
            await this.checkAndLockStock(
                validatedData.product,
                validatedData.sku,
                validatedData.quantity,
                transaction
            );

            // 4. å†³å®šå‘è´§æ–¹å¼å¹¶æ‹†å•
            const orders = await this.createOrdersWithSplit({
                ...validatedData,
                pricing
            }, transaction);

            // 5. å¤„ç†ä½£é‡‘
            await CommissionService.processOrderCommissions(orders, transaction);

            // 6. æ¸…ç†è´­ç‰©è½¦
            if (orderData.cart_id) {
                await this.removeFromCart(userId, orderData.cart_id, transaction);
            }

            return orders;
        });
    }

    /**
     * éªŒè¯è®¢å•æ•°æ®
     */
    async validateOrderData(orderData, userId, transaction) {
        const { product_id, sku_id, quantity, address_id } = orderData;

        if (!product_id || !quantity || quantity < 1) {
            throw new ValidationError('ç¼ºå°‘å¿…è¦å‚æ•°æˆ–å‚æ•°æ— æ•ˆ');
        }

        if (!address_id) {
            throw new ValidationError('è¯·é€‰æ‹©æ”¶è´§åœ°å€');
        }

        // æŸ¥è¯¢å•†å“
        const product = await Product.findByPk(product_id, {
            transaction,
            lock: transaction.LOCK.UPDATE
        });

        if (!product || product.status !== 1) {
            throw new NotFoundError('å•†å“ä¸å­˜åœ¨æˆ–å·²ä¸‹æ¶');
        }

        // æŸ¥è¯¢ SKUï¼ˆå¦‚æœæœ‰ï¼‰
        let sku = null;
        if (sku_id) {
            sku = await SKU.findOne({
                where: { id: sku_id, product_id, status: 1 },
                transaction,
                lock: transaction.LOCK.UPDATE
            });

            if (!sku) {
                throw new NotFoundError('å•†å“è§„æ ¼ä¸å­˜åœ¨');
            }
        }

        // æŸ¥è¯¢ç”¨æˆ·
        const user = await User.findByPk(userId, { transaction });

        // æŸ¥è¯¢åœ°å€
        const address = await Address.findByPk(address_id, { transaction });
        if (!address) {
            throw new NotFoundError('æ”¶è´§åœ°å€ä¸å­˜åœ¨');
        }

        return {
            product,
            sku,
            user,
            address,
            quantity,
            ...orderData
        };
    }

    /**
     * æ£€æŸ¥å¹¶é”å®šåº“å­˜
     */
    async checkAndLockStock(product, sku, quantity, transaction) {
        const stockTarget = sku || product;

        if (stockTarget.stock < quantity) {
            throw new StockError(`åº“å­˜ä¸è¶³ï¼Œå½“å‰ä»…å‰© ${stockTarget.stock} ä»¶`);
        }

        // æ‰£å‡åº“å­˜
        await stockTarget.decrement('stock', { by: quantity, transaction });

        // å¦‚æœæ˜¯ SKUï¼ŒåŒæ—¶æ‰£å‡å•†å“æ€»åº“å­˜
        if (sku) {
            await product.decrement('stock', { by: quantity, transaction });
        }
    }

    /**
     * æ ¹æ®ä»£ç†å•†åº“å­˜æ‹†å•
     */
    async createOrdersWithSplit(data, transaction) {
        const { user, product, sku, quantity, pricing, address } = data;

        // åœ°å€å¿«ç…§
        const addressSnapshot = {
            receiver_name: address.receiver_name,
            phone: address.phone,
            province: address.province,
            city: address.city,
            district: address.district,
            detail: address.detail
        };

        // è®¡ç®—æ‹†å•æ•°é‡
        const splitQuantities = await this.calculateSplitQuantities(user, quantity, transaction);

        const orders = [];

        // å…¬å…±å­—æ®µ
        const commonFields = {
            buyer_id: user.id,
            product_id: product.id,
            sku_id: sku ? sku.id : null,
            address_id: address.id,
            address_snapshot: addressSnapshot,
            remark: data.remark,
            status: 'pending',
            agent_id: user.agent_id,
            distributor_id: user.parent_id,
            locked_agent_cost: pricing.agentCost,
            platform_stock_deducted: 1
        };

        // åˆ›å»ºè®¢å•
        if (splitQuantities.agentQuantity > 0 && splitQuantities.platformQuantity > 0) {
            // æ‹†å•ï¼šä»£ç†å•† + å¹³å°
            const agentOrder = await Order.create({
                ...commonFields,
                order_no: this.generateOrderNo(),
                quantity: splitQuantities.agentQuantity,
                total_amount: pricing.price * splitQuantities.agentQuantity,
                actual_price: pricing.price * splitQuantities.agentQuantity,
                fulfillment_type: 'Agent_Pending'
            }, { transaction });

            const platformOrder = await Order.create({
                ...commonFields,
                order_no: this.generateOrderNo(),
                quantity: splitQuantities.platformQuantity,
                total_amount: pricing.price * splitQuantities.platformQuantity,
                actual_price: pricing.price * splitQuantities.platformQuantity,
                fulfillment_type: 'Company',
                parent_order_id: agentOrder.id
            }, { transaction });

            orders.push(agentOrder, platformOrder);
        } else if (splitQuantities.agentQuantity > 0) {
            // å…¨éƒ¨ä»£ç†å•†å‘è´§
            const order = await Order.create({
                ...commonFields,
                order_no: this.generateOrderNo(),
                quantity,
                total_amount: pricing.price * quantity,
                actual_price: pricing.price * quantity,
                fulfillment_type: 'Agent_Pending'
            }, { transaction });

            orders.push(order);
        } else {
            // å…¨éƒ¨å¹³å°å‘è´§
            const order = await Order.create({
                ...commonFields,
                order_no: this.generateOrderNo(),
                quantity,
                total_amount: pricing.price * quantity,
                actual_price: pricing.price * quantity,
                fulfillment_type: 'Company'
            }, { transaction });

            orders.push(order);
        }

        return orders;
    }

    /**
     * è®¡ç®—æ‹†å•æ•°é‡
     */
    async calculateSplitQuantities(user, totalQuantity, transaction) {
        let agentQuantity = 0;
        let platformQuantity = totalQuantity;

        if (user.agent_id) {
            const agent = await User.findByPk(user.agent_id, {
                transaction,
                lock: transaction.LOCK.UPDATE
            });

            if (agent && agent.role_level >= 3 && agent.stock_count > 0) {
                agentQuantity = Math.min(agent.stock_count, totalQuantity);
                platformQuantity = totalQuantity - agentQuantity;
            }
        }

        return { agentQuantity, platformQuantity };
    }

    /**
     * ç”Ÿæˆè®¢å•å·ï¼ˆæ”¹è¿›ç‰ˆï¼Œæ”¯æŒåˆ†å¸ƒå¼ï¼‰
     */
    generateOrderNo() {
        const { nanoid } = require('nanoid');
        const timestamp = Date.now();
        const randomId = nanoid(10);
        return `ORD${timestamp}${randomId}`;
    }

    /**
     * æ¸…ç†è´­ç‰©è½¦
     */
    async removeFromCart(userId, cartId, transaction) {
        await Cart.destroy({
            where: { id: cartId, user_id: userId },
            transaction
        });
    }
}

// è‡ªå®šä¹‰é”™è¯¯ç±»
class ValidationError extends Error {
    constructor(message) {
        super(message);
        this.name = 'ValidationError';
        this.statusCode = 400;
    }
}

class NotFoundError extends Error {
    constructor(message) {
        super(message);
        this.name = 'NotFoundError';
        this.statusCode = 404;
    }
}

class StockError extends Error {
    constructor(message) {
        super(message);
        this.name = 'StockError';
        this.statusCode = 400;
    }
}

module.exports = new OrderService();
```

ç„¶å Controller å˜å¾—éå¸¸ç®€æ´ï¼š

```javascript
// controllers/orderController.js (é‡æ„å)
const OrderService = require('../services/orderService');

const createOrder = async (req, res, next) => {
    try {
        const orders = await OrderService.createOrder(req.user.id, req.body);

        res.json({
            success: true,
            code: 0,
            message: 'è®¢å•åˆ›å»ºæˆåŠŸ',
            data: orders
        });
    } catch (error) {
        next(error);
    }
};

module.exports = { createOrder };
```

---

### é—®é¢˜ 1.2ï¼šä»·æ ¼è®¡ç®—é€»è¾‘é‡å¤
**ä½ç½®ï¼š** `controllers/orderController.js:69-78`ã€`controllers/cartController.js` ç­‰å¤šå¤„

**é—®é¢˜ï¼š**
ä»·æ ¼è®¡ç®—é€»è¾‘åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å‡ºç°ï¼š

```javascript
// orderController.js
if (roleLevel >= 1 && sku.member_price) price = parseFloat(sku.member_price);
if (roleLevel >= 2 && sku.wholesale_price) price = parseFloat(sku.wholesale_price);

// ç±»ä¼¼çš„ä»£ç åœ¨ cartControllerã€productController ä¸­éƒ½æœ‰
```

**å»ºè®®æ”¹è¿›ï¼š**

åˆ›å»ºä¸“é—¨çš„å®šä»·æœåŠ¡ï¼š

```javascript
// services/pricingService.js
const constants = require('../config/constants');

class PricingService {
    /**
     * è®¡ç®—ç”¨æˆ·çš„å•†å“ä»·æ ¼
     * @param {Object} product - å•†å“å¯¹è±¡
     * @param {Object} sku - SKU å¯¹è±¡ï¼ˆå¯é€‰ï¼‰
     * @param {Object} user - ç”¨æˆ·å¯¹è±¡
     * @returns {number} ä»·æ ¼
     */
    static calculateUserPrice(product, sku = null, user) {
        const roleLevel = user.role_level || constants.ROLES.GUEST;

        if (sku) {
            return this.calculateSkuPrice(sku, roleLevel);
        } else {
            return this.calculateProductPrice(product, roleLevel);
        }
    }

    /**
     * è®¡ç®— SKU ä»·æ ¼
     */
    static calculateSkuPrice(sku, roleLevel) {
        const priceMap = {
            [constants.ROLES.GUEST]: sku.retail_price,
            [constants.ROLES.MEMBER]: sku.member_price || sku.retail_price,
            [constants.ROLES.LEADER]: sku.wholesale_price || sku.member_price || sku.retail_price,
            [constants.ROLES.AGENT]: sku.wholesale_price || sku.member_price || sku.retail_price
        };

        return parseFloat(priceMap[roleLevel] || sku.retail_price);
    }

    /**
     * è®¡ç®—å•†å“ä»·æ ¼
     */
    static calculateProductPrice(product, roleLevel) {
        const priceMap = {
            [constants.ROLES.GUEST]: product.retail_price,
            [constants.ROLES.MEMBER]: product.price_member || product.retail_price,
            [constants.ROLES.LEADER]: product.price_leader || product.price_member || product.retail_price,
            [constants.ROLES.AGENT]: product.price_agent || product.price_leader || product.price_member || product.retail_price
        };

        return parseFloat(priceMap[roleLevel] || product.retail_price);
    }

    /**
     * è®¡ç®—è®¢å•å®šä»·ä¿¡æ¯ï¼ˆåŒ…å«ä»£ç†å•†æˆæœ¬ç­‰ï¼‰
     */
    static calculateOrderPricing(product, sku, user, quantity) {
        const price = this.calculateUserPrice(product, sku, user);
        const agentCost = parseFloat(
            product.price_agent ||
            product.price_leader ||
            product.price_member ||
            product.retail_price
        );

        return {
            price,              // ç”¨æˆ·æ”¯ä»˜ä»·æ ¼
            agentCost,          // ä»£ç†å•†è¿›è´§æˆæœ¬
            totalAmount: price * quantity,
            profit: (price - agentCost) * quantity
        };
    }
}

module.exports = PricingService;
```

ä½¿ç”¨ï¼š

```javascript
// controllers/orderController.js
const PricingService = require('../services/pricingService');

const pricing = PricingService.calculateOrderPricing(product, sku, user, quantity);
```

---

## 2. æ€§èƒ½é—®é¢˜

### é—®é¢˜ 2.1ï¼šç¼ºå°‘ç¼“å­˜æœºåˆ¶
**å½±å“ï¼š** æ‰€æœ‰æ§åˆ¶å™¨

**é—®é¢˜ï¼š**
çƒ­ç‚¹æ•°æ®ï¼ˆå•†å“åˆ†ç±»ã€å•†å“è¯¦æƒ…ã€ç”¨æˆ·ä¿¡æ¯ï¼‰æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“ï¼Œæ²¡æœ‰ç¼“å­˜ã€‚

**å»ºè®®æ”¹è¿›ï¼š**

å¼•å…¥ Redis ç¼“å­˜æœåŠ¡ï¼š

```javascript
// services/cacheService.js
const Redis = require('ioredis');

class CacheService {
    constructor() {
        this.redis = new Redis({
            host: process.env.REDIS_HOST || 'localhost',
            port: process.env.REDIS_PORT || 6379,
            password: process.env.REDIS_PASSWORD,
            db: process.env.REDIS_DB || 0,
            retryStrategy: (times) => {
                const delay = Math.min(times * 50, 2000);
                return delay;
            }
        });

        this.redis.on('error', (err) => {
            console.error('Redisè¿æ¥é”™è¯¯:', err);
        });

        this.redis.on('connect', () => {
            console.log('âœ“ Redis è¿æ¥æˆåŠŸ');
        });
    }

    /**
     * è·å–ç¼“å­˜
     */
    async get(key) {
        try {
            const value = await this.redis.get(key);
            return value ? JSON.parse(value) : null;
        } catch (error) {
            console.error('ç¼“å­˜è¯»å–å¤±è´¥:', error);
            return null;
        }
    }

    /**
     * è®¾ç½®ç¼“å­˜
     * @param {string} key - é”®
     * @param {*} value - å€¼
     * @param {number} ttl - è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1 å°æ—¶
     */
    async set(key, value, ttl = 3600) {
        try {
            await this.redis.setex(key, ttl, JSON.stringify(value));
            return true;
        } catch (error) {
            console.error('ç¼“å­˜å†™å…¥å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * åˆ é™¤ç¼“å­˜
     */
    async del(key) {
        try {
            await this.redis.del(key);
            return true;
        } catch (error) {
            console.error('ç¼“å­˜åˆ é™¤å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * æ‰¹é‡åˆ é™¤ï¼ˆé€šè¿‡æ¨¡å¼åŒ¹é…ï¼‰
     */
    async delByPattern(pattern) {
        try {
            const keys = await this.redis.keys(pattern);
            if (keys.length > 0) {
                await this.redis.del(...keys);
            }
            return true;
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤ç¼“å­˜å¤±è´¥:', error);
            return false;
        }
    }

    /**
     * ç¼“å­˜è£…é¥°å™¨ - è‡ªåŠ¨ç¼“å­˜å‡½æ•°ç»“æœ
     */
    cache(keyPrefix, ttl = 3600) {
        return (target, propertyKey, descriptor) => {
            const originalMethod = descriptor.value;

            descriptor.value = async function (...args) {
                const cacheKey = `${keyPrefix}:${JSON.stringify(args)}`;

                // å°è¯•ä»ç¼“å­˜è¯»å–
                const cached = await this.cacheService.get(cacheKey);
                if (cached) {
                    return cached;
                }

                // æ‰§è¡ŒåŸæ–¹æ³•
                const result = await originalMethod.apply(this, args);

                // å†™å…¥ç¼“å­˜
                await this.cacheService.set(cacheKey, result, ttl);

                return result;
            };

            return descriptor;
        };
    }
}

module.exports = new CacheService();
```

åœ¨ Controller ä¸­ä½¿ç”¨ï¼š

```javascript
// controllers/productController.js
const CacheService = require('../services/cacheService');

// è·å–å•†å“è¯¦æƒ…ï¼ˆå¸¦ç¼“å­˜ï¼‰
const getProductDetail = async (req, res, next) => {
    try {
        const { id } = req.params;
        const cacheKey = `product:${id}`;

        // 1. å°è¯•ä»ç¼“å­˜è·å–
        let product = await CacheService.get(cacheKey);

        if (!product) {
            // 2. ç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“
            product = await Product.findByPk(id, {
                include: [{ model: SKU, as: 'skus' }]
            });

            if (!product) {
                return res.status(404).json({
                    success: false,
                    message: 'å•†å“ä¸å­˜åœ¨'
                });
            }

            // 3. å†™å…¥ç¼“å­˜ï¼ˆ1å°æ—¶è¿‡æœŸï¼‰
            await CacheService.set(cacheKey, product, 3600);
        }

        res.json({
            success: true,
            data: product
        });
    } catch (error) {
        next(error);
    }
};

// æ›´æ–°å•†å“æ—¶æ¸…é™¤ç¼“å­˜
const updateProduct = async (req, res, next) => {
    try {
        const { id } = req.params;

        await Product.update(req.body, { where: { id } });

        // æ¸…é™¤ç¼“å­˜
        await CacheService.del(`product:${id}`);

        res.json({ success: true, message: 'æ›´æ–°æˆåŠŸ' });
    } catch (error) {
        next(error);
    }
};
```

---

### é—®é¢˜ 2.2ï¼šæ·±åº¦åˆ†é¡µæ€§èƒ½å·®
**ä½ç½®ï¼š** å¤šä¸ª Controller ä¸­çš„åˆ—è¡¨æŸ¥è¯¢

**é—®é¢˜ï¼š**
ä½¿ç”¨ `offset` è¿›è¡Œåˆ†é¡µï¼Œé¡µç å¾ˆå¤§æ—¶æ€§èƒ½å¾ˆå·®ï¼š

```javascript
const products = await Product.findAll({
    offset: (page - 1) * limit,  // page å¾ˆå¤§æ—¶æ‰«æå¤§é‡æ•°æ®
    limit
});
```

**å»ºè®®æ”¹è¿›ï¼š**

ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µï¼ˆCursor-based Paginationï¼‰ï¼š

```javascript
// controllers/productController.js
const getProducts = async (req, res, next) => {
    try {
        const { cursor, limit = 20 } = req.query;
        const parsedLimit = Math.min(parseInt(limit), 100);

        const whereClause = { status: 1 };

        // å¦‚æœæœ‰æ¸¸æ ‡ï¼Œæ·»åŠ  ID æ¡ä»¶
        if (cursor) {
            whereClause.id = { [Op.gt]: parseInt(cursor) };
        }

        const products = await Product.findAll({
            where: whereClause,
            limit: parsedLimit + 1,  // å¤šæŸ¥ä¸€æ¡ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
            order: [['id', 'ASC']]
        });

        const hasMore = products.length > parsedLimit;
        const items = hasMore ? products.slice(0, parsedLimit) : products;
        const nextCursor = hasMore ? items[items.length - 1].id : null;

        res.json({
            success: true,
            data: {
                items,
                nextCursor,
                hasMore
            }
        });
    } catch (error) {
        next(error);
    }
};
```

---

## 3. ä¸šåŠ¡é€»è¾‘é—®é¢˜

### é—®é¢˜ 3.1ï¼šè®¢å•å·ç”Ÿæˆä¸æ”¯æŒåˆ†å¸ƒå¼
**ä½ç½®ï¼š** `controllers/orderController.js:6-23`

**é—®é¢˜ï¼š**
å½“å‰è®¢å•å·ç”Ÿæˆä½¿ç”¨è¿›ç¨‹å†…åºåˆ—å·ï¼š

```javascript
let _orderSeq = 0;

const generateOrderNo = () => {
    _orderSeq = (_orderSeq + 1) % 10000;
    // ...
};
```

å¤šå®ä¾‹éƒ¨ç½²æ—¶ä¼šå†²çªã€‚

**å»ºè®®æ”¹è¿›ï¼š**

æ–¹æ¡ˆ1ï¼šä½¿ç”¨ nanoid æˆ– UUIDï¼š

```javascript
const { nanoid } = require('nanoid');

const generateOrderNo = () => {
    const timestamp = Date.now().toString(36);  // 36è¿›åˆ¶æ—¶é—´æˆ³
    const randomId = nanoid(10);
    return `ORD${timestamp.toUpperCase()}${randomId.toUpperCase()}`;
};
```

æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Snowflake ç®—æ³•ï¼š

```javascript
const Snowflake = require('nodejs-snowflake').Snowflake;

// æ¯ä¸ªå®ä¾‹é…ç½®ä¸åŒçš„ workerId
const snowflake = new Snowflake({
    custom_epoch: 1609459200000,  // 2021-01-01
    instance_id: process.env.INSTANCE_ID || 1  // ä»ç¯å¢ƒå˜é‡è¯»å–
});

const generateOrderNo = () => {
    const id = snowflake.getUniqueID();
    return `ORD${id}`;
};
```

---

### é—®é¢˜ 3.2ï¼šå®šæ—¶ä»»åŠ¡ä¸æ”¯æŒåˆ†å¸ƒå¼
**ä½ç½®ï¼š** `server.js:50-98`

**é—®é¢˜ï¼š**
ä½¿ç”¨ `setInterval` å®ç°å®šæ—¶ä»»åŠ¡ï¼Œå¤šå®ä¾‹éƒ¨ç½²æ—¶ä¼šé‡å¤æ‰§è¡Œï¼š

```javascript
setInterval(async () => {
    await settleCommissions();  // å¤šä¸ªå®ä¾‹ä¼šåŒæ—¶æ‰§è¡Œ
}, constants.COMMISSION.SETTLE_INTERVAL_MS);
```

**å»ºè®®æ”¹è¿›ï¼š**

ä½¿ç”¨ Bull é˜Ÿåˆ— + Redis åˆ†å¸ƒå¼é”ï¼š

```javascript
// jobs/commissionJob.js
const Bull = require('bull');
const { settleCommissions } = require('../controllers/orderController');

const commissionQueue = new Bull('commission-settlement', {
    redis: {
        host: process.env.REDIS_HOST || 'localhost',
        port: process.env.REDIS_PORT || 6379
    }
});

// å®šä¹‰ä»»åŠ¡å¤„ç†å™¨
commissionQueue.process(async (job) => {
    console.log('å¼€å§‹å¤„ç†ä½£é‡‘ç»“ç®—ä»»åŠ¡');

    try {
        const count = await settleCommissions();
        console.log(`ä½£é‡‘ç»“ç®—å®Œæˆ: ${count} æ¡è®°å½•`);
        return { success: true, count };
    } catch (error) {
        console.error('ä½£é‡‘ç»“ç®—å¤±è´¥:', error);
        throw error;  // Bull ä¼šè‡ªåŠ¨é‡è¯•
    }
});

// æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆä½¿ç”¨ cron è¡¨è¾¾å¼ï¼‰
commissionQueue.add(
    {},
    {
        repeat: {
            cron: '0 * * * *'  // æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
        }
    }
);

module.exports = commissionQueue;
```

```javascript
// server.js (ä¿®æ”¹å)
// ç§»é™¤ setIntervalï¼Œæ”¹ç”¨ Bull é˜Ÿåˆ—
const commissionQueue = require('./jobs/commissionJob');
const orderQueue = require('./jobs/orderJob');
const refundQueue = require('./jobs/refundJob');

console.log('å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—å·²å¯åŠ¨');
```

---

## 4. å®‰å…¨é—®é¢˜

### é—®é¢˜ 4.1ï¼šæ—¥å¿—å¯èƒ½æ³„éœ²æ•æ„Ÿä¿¡æ¯
**ä½ç½®ï¼š** `config/database.js:13`ã€å¤šä¸ª Controller ä¸­çš„ `console.log`

**é—®é¢˜ï¼š**
å¼€å‘ç¯å¢ƒä¼šæ‰“å° SQL è¯­å¥ï¼Œå¯èƒ½åŒ…å«æ•æ„Ÿæ•°æ®ï¼š

```javascript
logging: process.env.NODE_ENV === 'development' ? console.log : false,
```

**å»ºè®®æ”¹è¿›ï¼š**

ä½¿ç”¨ä¸“ä¸šæ—¥å¿—åº“ï¼Œè‡ªåŠ¨è„±æ•ï¼š

```javascript
// utils/logger.js
const winston = require('winston');
const DailyRotateFile = require('winston-daily-rotate-file');

// æ•æ„Ÿå­—æ®µæ­£åˆ™
const sensitiveFields = /password|token|secret|key|authorization/gi;

// è„±æ•æ ¼å¼åŒ–å™¨
const desensitizeFormat = winston.format((info) => {
    const desensitize = (obj) => {
        if (typeof obj === 'string') {
            return obj.replace(sensitiveFields, '[REDACTED]');
        }

        if (typeof obj === 'object' && obj !== null) {
            for (const key in obj) {
                if (sensitiveFields.test(key)) {
                    obj[key] = '[REDACTED]';
                } else {
                    obj[key] = desensitize(obj[key]);
                }
            }
        }

        return obj;
    };

    return desensitize(info);
});

// åˆ›å»º logger
const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        desensitizeFormat(),
        winston.format.errors({ stack: true }),
        winston.format.json()
    ),
    transports: [
        // æ§åˆ¶å°è¾“å‡º
        new winston.transports.Console({
            format: winston.format.combine(
                winston.format.colorize(),
                winston.format.simple()
            )
        }),

        // æ–‡ä»¶è¾“å‡º - æŒ‰æ—¥æœŸè½®è½¬
        new DailyRotateFile({
            filename: 'logs/application-%DATE%.log',
            datePattern: 'YYYY-MM-DD',
            maxSize: '20m',
            maxFiles: '14d'
        }),

        // é”™è¯¯æ—¥å¿—å•ç‹¬è®°å½•
        new DailyRotateFile({
            level: 'error',
            filename: 'logs/error-%DATE%.log',
            datePattern: 'YYYY-MM-DD',
            maxSize: '20m',
            maxFiles: '30d'
        })
    ]
});

module.exports = logger;
```

ä½¿ç”¨ï¼š

```javascript
// config/database.js
const logger = require('../utils/logger');

const sequelize = new Sequelize(/* ... */, {
    logging: (sql) => logger.debug(sql),  // ä½¿ç”¨ logger æ›¿ä»£ console.log
    // ...
});
```

```javascript
// controllers/*.js
const logger = require('../utils/logger');

// æ›¿æ¢æ‰€æœ‰ console.log
logger.info('ç”¨æˆ·ç™»å½•', { userId: user.id });
logger.error('è®¢å•åˆ›å»ºå¤±è´¥', { error: err.message, userId });
```

---

### é—®é¢˜ 4.2ï¼šç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯
**ä½ç½®ï¼š** `.env.example`

**é—®é¢˜ï¼š**
ç¤ºä¾‹æ–‡ä»¶ä¸­æœ‰é»˜è®¤å¯†é’¥ï¼Œå¼€å‘è€…å¯èƒ½ç›´æ¥ä½¿ç”¨ï¼š

```
JWT_SECRET=your_super_secret_key_at_least_32_chars_long_change_this_in_production
```

**å»ºè®®æ”¹è¿›ï¼š**

1. ä¸åœ¨ç¤ºä¾‹æ–‡ä»¶ä¸­æä¾›é»˜è®¤å¯†é’¥ï¼š

```
# .env.example
# ========== JWT é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼ï¼‰ ==========
# è¯·ç”Ÿæˆè‡³å°‘32ä½çš„éšæœºå­—ç¬¦ä¸²
# å¯ä»¥ä½¿ç”¨å‘½ä»¤: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
JWT_SECRET=
JWT_EXPIRES_IN=7d
ADMIN_JWT_SECRET=
ADMIN_JWT_EXPIRES_IN=24h
```

2. æä¾›è„šæœ¬ç”Ÿæˆå¯†é’¥ï¼š

```javascript
// scripts/generate-secrets.js
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');

const generateSecret = (length = 32) => {
    return crypto.randomBytes(length).toString('hex');
};

const envPath = path.join(__dirname, '..', '.env');
const envExamplePath = path.join(__dirname, '..', '.env.example');

// è¯»å– .env.example
let envContent = fs.readFileSync(envExamplePath, 'utf8');

// æ›¿æ¢ç©ºçš„å¯†é’¥
envContent = envContent.replace(/JWT_SECRET=$/m, `JWT_SECRET=${generateSecret()}`);
envContent = envContent.replace(/ADMIN_JWT_SECRET=$/m, `ADMIN_JWT_SECRET=${generateSecret()}`);
envContent = envContent.replace(/DB_PASSWORD=$/m, `DB_PASSWORD=${generateSecret(16)}`);

// å†™å…¥ .env
fs.writeFileSync(envPath, envContent);

console.log('âœ“ .env æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¯†é’¥å·²è‡ªåŠ¨å¡«å……');
console.log('âš ï¸  è¯·æ‰‹åŠ¨é…ç½®å…¶ä»–ç¯å¢ƒå˜é‡ï¼ˆæ•°æ®åº“ã€å¾®ä¿¡ç­‰ï¼‰');
```

3. æ›´æ–° README.mdï¼š

```markdown
## å¿«é€Ÿå¼€å§‹

1. å…‹éš†é¡¹ç›®
2. å®‰è£…ä¾èµ–ï¼š`npm install`
3. ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼š`npm run generate:secrets`
4. ç¼–è¾‘ `.env` æ–‡ä»¶ï¼Œé…ç½®æ•°æ®åº“å’Œå¾®ä¿¡å‚æ•°
5. å¯åŠ¨æœåŠ¡ï¼š`npm start`
```

---

## 5. æµ‹è¯•é—®é¢˜

### é—®é¢˜ 5.1ï¼šç¼ºå°‘å•å…ƒæµ‹è¯•
**å½±å“ï¼š** æ•´ä¸ªé¡¹ç›®

**å»ºè®®ï¼š**

åˆ›å»ºæµ‹è¯•æ¡†æ¶ï¼š

```javascript
// package.json
{
  "scripts": {
    "test": "jest --coverage",
    "test:watch": "jest --watch",
    "test:unit": "jest --testPathPattern=tests/unit",
    "test:integration": "jest --testPathPattern=tests/integration"
  },
  "devDependencies": {
    "jest": "^29.5.0",
    "supertest": "^6.3.3",
    "@types/jest": "^29.5.0"
  }
}
```

```javascript
// jest.config.js
module.exports = {
    testEnvironment: 'node',
    coverageDirectory: 'coverage',
    collectCoverageFrom: [
        'controllers/**/*.js',
        'services/**/*.js',
        'utils/**/*.js',
        '!**/node_modules/**'
    ],
    testMatch: [
        '**/tests/**/*.test.js'
    ],
    setupFilesAfterEnv: ['<rootDir>/tests/setup.js']
};
```

ç¼–å†™æµ‹è¯•ï¼š

```javascript
// tests/unit/utils/pricing.test.js
const PricingService = require('../../../services/pricingService');
const constants = require('../../../config/constants');

describe('PricingService', () => {
    describe('calculateUserPrice', () => {
        const mockProduct = {
            retail_price: 100,
            price_member: 80,
            price_leader: 60,
            price_agent: 50
        };

        it('should return retail price for guest', () => {
            const user = { role_level: constants.ROLES.GUEST };
            const price = PricingService.calculateUserPrice(mockProduct, null, user);
            expect(price).toBe(100);
        });

        it('should return member price for member', () => {
            const user = { role_level: constants.ROLES.MEMBER };
            const price = PricingService.calculateUserPrice(mockProduct, null, user);
            expect(price).toBe(80);
        });

        it('should return leader price for leader', () => {
            const user = { role_level: constants.ROLES.LEADER };
            const price = PricingService.calculateUserPrice(mockProduct, null, user);
            expect(price).toBe(60);
        });

        it('should return agent price for agent', () => {
            const user = { role_level: constants.ROLES.AGENT };
            const price = PricingService.calculateUserPrice(mockProduct, null, user);
            expect(price).toBe(50);
        });

        it('should fallback to retail price if member price not set', () => {
            const product = { retail_price: 100 };
            const user = { role_level: constants.ROLES.MEMBER };
            const price = PricingService.calculateUserPrice(product, null, user);
            expect(price).toBe(100);
        });
    });
});
```

```javascript
// tests/integration/auth.test.js
const request = require('supertest');
const app = require('../../app');
const { User, sequelize } = require('../../models');

describe('Auth API', () => {
    beforeAll(async () => {
        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        await sequelize.authenticate();
    });

    beforeEach(async () => {
        // æ¸…ç©ºç”¨æˆ·è¡¨
        await User.destroy({ where: {}, force: true });
    });

    afterAll(async () => {
        await sequelize.close();
    });

    describe('POST /api/login', () => {
        it('should create new user on first login', async () => {
            const mockWechatResponse = {
                openid: 'test_openid_123',
                session_key: 'test_session_key'
            };

            // Mock å¾®ä¿¡æ¥å£
            jest.spyOn(require('../../utils/wechat'), 'code2Session')
                .mockResolvedValue(mockWechatResponse);

            const response = await request(app)
                .post('/api/login')
                .send({
                    code: 'test_code',
                    nickName: 'æµ‹è¯•ç”¨æˆ·',
                    avatarUrl: 'https://example.com/avatar.jpg'
                });

            expect(response.status).toBe(200);
            expect(response.body.success).toBe(true);
            expect(response.body.token).toBeDefined();
            expect(response.body.userInfo.openid).toBe(mockWechatResponse.openid);

            // éªŒè¯æ•°æ®åº“
            const user = await User.findOne({
                where: { openid: mockWechatResponse.openid }
            });
            expect(user).toBeTruthy();
            expect(user.nickname).toBe('æµ‹è¯•ç”¨æˆ·');
        });

        it('should return existing user on subsequent logins', async () => {
            // å…ˆåˆ›å»ºç”¨æˆ·
            const existingUser = await User.create({
                openid: 'existing_openid',
                nickname: 'å·²å­˜åœ¨ç”¨æˆ·',
                invite_code: '123456'
            });

            const mockWechatResponse = {
                openid: 'existing_openid',
                session_key: 'test_session_key'
            };

            jest.spyOn(require('../../utils/wechat'), 'code2Session')
                .mockResolvedValue(mockWechatResponse);

            const response = await request(app)
                .post('/api/login')
                .send({ code: 'test_code' });

            expect(response.status).toBe(200);
            expect(response.body.userInfo.id).toBe(existingUser.id);
        });

        it('should return 400 if code is missing', async () => {
            const response = await request(app)
                .post('/api/login')
                .send({});

            expect(response.status).toBe(400);
            expect(response.body.success).toBe(false);
        });
    });
});
```

---

## 6. API æ–‡æ¡£é—®é¢˜

### é—®é¢˜ 6.1ï¼šç¼ºå°‘ API æ–‡æ¡£
**å½±å“ï¼š** å‰åç«¯åä½œæ•ˆç‡

**å»ºè®®ï¼š**

é›†æˆ Swaggerï¼š

```javascript
// package.json
{
  "dependencies": {
    "swagger-jsdoc": "^6.2.8",
    "swagger-ui-express": "^5.0.0"
  }
}
```

```javascript
// swagger.js
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
    definition: {
        openapi: '3.0.0',
        info: {
            title: 'S2B2C API Documentation',
            version: '1.0.0',
            description: 'S2B2C ç”µå•†åˆ†é”€ç³»ç»Ÿ API æ–‡æ¡£'
        },
        servers: [
            {
                url: process.env.API_BASE_URL || 'http://localhost:3000/api',
                description: 'å¼€å‘æœåŠ¡å™¨'
            }
        ],
        components: {
            securitySchemes: {
                bearerAuth: {
                    type: 'http',
                    scheme: 'bearer',
                    bearerFormat: 'JWT'
                }
            }
        }
    },
    apis: ['./routes/*.js', './controllers/*.js']
};

const specs = swaggerJsdoc(options);

module.exports = { specs, swaggerUi };
```

```javascript
// app.js (æ·»åŠ  Swagger è·¯ç”±)
const { specs, swaggerUi } = require('./swagger');

// API æ–‡æ¡£ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
if (process.env.NODE_ENV === 'development') {
    app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs));
    console.log('ğŸ“– API æ–‡æ¡£: http://localhost:3000/api-docs');
}
```

åœ¨è·¯ç”±ä¸­æ·»åŠ æ–‡æ¡£æ³¨é‡Šï¼š

```javascript
// routes/orders.js
/**
 * @swagger
 * /orders:
 *   post:
 *     summary: åˆ›å»ºè®¢å•
 *     tags: [è®¢å•]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - product_id
 *               - quantity
 *               - address_id
 *             properties:
 *               product_id:
 *                 type: integer
 *                 description: å•†å“ID
 *               sku_id:
 *                 type: integer
 *                 description: SKU IDï¼ˆå¯é€‰ï¼‰
 *               quantity:
 *                 type: integer
 *                 minimum: 1
 *                 description: è´­ä¹°æ•°é‡
 *               address_id:
 *                 type: integer
 *                 description: æ”¶è´§åœ°å€ID
 *               remark:
 *                 type: string
 *                 description: è®¢å•å¤‡æ³¨
 *               cart_id:
 *                 type: integer
 *                 description: è´­ç‰©è½¦IDï¼ˆä»è´­ç‰©è½¦ä¸‹å•æ—¶æä¾›ï¼‰
 *     responses:
 *       200:
 *         description: è®¢å•åˆ›å»ºæˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 code:
 *                   type: integer
 *                 message:
 *                   type: string
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Order'
 *       400:
 *         description: å‚æ•°é”™è¯¯æˆ–åº“å­˜ä¸è¶³
 *       401:
 *         description: æœªç™»å½•
 */
router.post('/', authenticate, createOrder);
```

---

## 7. ç›‘æ§é—®é¢˜

### é—®é¢˜ 7.1ï¼šç¼ºå°‘æ€§èƒ½ç›‘æ§
**å½±å“ï¼š** ç”Ÿäº§ç¯å¢ƒé—®é¢˜éš¾ä»¥æ’æŸ¥

**å»ºè®®ï¼š**

é›†æˆ Prometheusï¼š

```javascript
// package.json
{
  "dependencies": {
    "prom-client": "^14.2.0"
  }
}
```

```javascript
// utils/metrics.js
const client = require('prom-client');

// åˆ›å»º Registry
const register = new client.Registry();

// é»˜è®¤æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ç­‰ï¼‰
client.collectDefaultMetrics({ register });

// è‡ªå®šä¹‰æŒ‡æ ‡
const httpRequestDuration = new client.Histogram({
    name: 'http_request_duration_seconds',
    help: 'HTTP è¯·æ±‚è€—æ—¶ï¼ˆç§’ï¼‰',
    labelNames: ['method', 'route', 'status_code'],
    buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]
});

const httpRequestTotal = new client.Counter({
    name: 'http_requests_total',
    help: 'HTTP è¯·æ±‚æ€»æ•°',
    labelNames: ['method', 'route', 'status_code']
});

const dbQueryDuration = new client.Histogram({
    name: 'db_query_duration_seconds',
    help: 'æ•°æ®åº“æŸ¥è¯¢è€—æ—¶ï¼ˆç§’ï¼‰',
    labelNames: ['operation'],
    buckets: [0.001, 0.01, 0.05, 0.1, 0.5, 1]
});

const orderCreatedTotal = new client.Counter({
    name: 'orders_created_total',
    help: 'åˆ›å»ºè®¢å•æ€»æ•°',
    labelNames: ['status']
});

register.registerMetric(httpRequestDuration);
register.registerMetric(httpRequestTotal);
register.registerMetric(dbQueryDuration);
register.registerMetric(orderCreatedTotal);

module.exports = {
    register,
    httpRequestDuration,
    httpRequestTotal,
    dbQueryDuration,
    orderCreatedTotal
};
```

```javascript
// middleware/metrics.js
const { httpRequestDuration, httpRequestTotal } = require('../utils/metrics');

function metricsMiddleware(req, res, next) {
    const start = Date.now();

    // å“åº”å®Œæˆæ—¶è®°å½•æŒ‡æ ‡
    res.on('finish', () => {
        const duration = (Date.now() - start) / 1000;
        const route = req.route ? req.route.path : req.path;

        httpRequestDuration
            .labels(req.method, route, res.statusCode)
            .observe(duration);

        httpRequestTotal
            .labels(req.method, route, res.statusCode)
            .inc();
    });

    next();
}

module.exports = metricsMiddleware;
```

```javascript
// app.js
const metricsMiddleware = require('./middleware/metrics');
const { register } = require('./utils/metrics');

// æ·»åŠ æŒ‡æ ‡ä¸­é—´ä»¶
app.use(metricsMiddleware);

// Prometheus æŒ‡æ ‡ç«¯ç‚¹
app.get('/metrics', async (req, res) => {
    res.set('Content-Type', register.contentType);
    res.end(await register.metrics());
});
```

åœ¨ä¸šåŠ¡ä»£ç ä¸­è®°å½•æŒ‡æ ‡ï¼š

```javascript
// controllers/orderController.js
const { orderCreatedTotal, dbQueryDuration } = require('../utils/metrics');

const createOrder = async (req, res, next) => {
    const queryStart = Date.now();

    try {
        const orders = await OrderService.createOrder(req.user.id, req.body);

        // è®°å½•æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
        const queryDuration = (Date.now() - queryStart) / 1000;
        dbQueryDuration.labels('create_order').observe(queryDuration);

        // è®°å½•è®¢å•åˆ›å»ºæ•°é‡
        orderCreatedTotal.labels('success').inc(orders.length);

        res.json({ success: true, data: orders });
    } catch (error) {
        orderCreatedTotal.labels('failed').inc();
        next(error);
    }
};
```

---

## æ€»ç»“

åç«¯ä»£ç è™½ç„¶ç›¸å¯¹æˆç†Ÿï¼Œä½†ä»æœ‰ä»¥ä¸‹å…³é”®æ”¹è¿›ç‚¹ï¼š

### ç«‹å³æ”¹è¿›ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
1. âœ… **å¼•å…¥ Service å±‚** - è§£è€¦ä¸šåŠ¡é€»è¾‘
2. âœ… **æ·»åŠ  Redis ç¼“å­˜** - æå‡æ€§èƒ½
3. âœ… **ç¼–å†™å•å…ƒæµ‹è¯•** - æé«˜ä»£ç è´¨é‡
4. âœ… **é›†æˆ Swagger** - å®Œå–„ API æ–‡æ¡£
5. âœ… **æ”¹è¿›è®¢å•å·ç”Ÿæˆ** - æ”¯æŒåˆ†å¸ƒå¼

### ä¸­æœŸæ”¹è¿›ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰
1. âœ… **æå–é‡å¤ä»£ç ** - PricingService
2. âœ… **ä½¿ç”¨ Bull é˜Ÿåˆ—** - æ›¿ä»£ setInterval
3. âœ… **Winston æ—¥å¿—** - æ›¿ä»£ console.log
4. âœ… **Prometheus ç›‘æ§** - ç”Ÿäº§ç¯å¢ƒå¿…å¤‡
5. âœ… **æ¸¸æ ‡åˆ†é¡µ** - ä¼˜åŒ–æ·±åº¦åˆ†é¡µ

### é•¿æœŸä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
1. âœ… **é“¾è·¯è¿½è¸ª** - Jaeger/Zipkin
2. âœ… **æ€§èƒ½å‹æµ‹** - æ‰¾å‡ºç“¶é¢ˆ
3. âœ… **ä»£ç è¦†ç›–ç‡** - æå‡åˆ° 80%+
4. âœ… **é”™è¯¯ç ä½“ç³»** - ç»Ÿä¸€é”™è¯¯å¤„ç†

æŒ‰ç…§è¿™ä¸ªæ¸…å•é€æ­¥æ”¹è¿›ï¼Œåç«¯ä»£ç è´¨é‡å¯ä»¥ä» **7.7/10** æå‡åˆ° **9/10** ä»¥ä¸Šã€‚
